name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version_tag:
        description: "Version tag for release (e.g. v0.2.0)"
        required: true
        default: "v0.2.0"

      platforms:
        description: "Comma-separated platforms (like --platforms). Ignored if all_platforms=true"
        required: false
        default: "linux-x86_64,macos-aarch64,windows-x86_64,linux-aarch64"

      all_platforms:
        description: "Build all platforms (like --all-platforms)"
        type: boolean
        required: false
        default: false

      github_release:
        description: "Publish GitHub Release"
        type: boolean
        required: false
        default: true

      docker_push:
        description: "Push Docker image to Docker Hub"
        type: boolean
        required: false
        default: true

      docker_repo:
        description: "Docker Hub repo (owner/name)"
        required: false
        default: "jamals86/kalamdb"

      npm_publish:
        description: "Publish TypeScript SDK to npm"
        type: boolean
        required: false
        default: true

      force_npm_publish:
        description: "Force republish (unpublish existing version first)"
        type: boolean
        required: false
        default: false

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: "1.92.0"
  DEFAULT_PLATFORMS: "linux-x86_64,macos-aarch64,windows-x86_64"

jobs:
  build_ui:
    name: Build Admin UI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: wasm-build
          cache-on-failure: true

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install wasm-pack
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL --retry 5 --retry-delay 2 --retry-connrefused \
            https://rustwasm.github.io/wasm-pack/installer/init.sh | sh
          wasm-pack --version

      - name: Build SDK (kalam-link)
        shell: bash
        run: |
          set -euo pipefail
          cd link/sdks/typescript
          npm install
          npm run build

      - name: Build Admin UI
        shell: bash
        run: |
          set -euo pipefail
          cd ui
          npm install
          npm run build

      - name: Upload UI dist
        uses: actions/upload-artifact@v4
        with:
          name: ui-dist
          path: ui/dist/
          if-no-files-found: error

  build_cli_linux_x86_64:
    name: Build CLI Linux x86_64
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${{ github.event.inputs.version_tag }}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-unknown-linux-gnu

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: cli-linux-x86_64-ubuntu-22-04
          cache-on-failure: true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang \
            libclang-dev \
            pkg-config \
            libssl-dev

      - name: Build CLI linux-x86_64
        shell: bash
        run: |
          set -euo pipefail
          cargo build \
            --profile release-dist \
            --target x86_64-unknown-linux-gnu \
            --bin kalam

      - name: Package CLI artifact
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION
          CLI_OUT="kalamcli-${VERSION}-linux-x86_64"
          cp "target/x86_64-unknown-linux-gnu/release-dist/kalam" "dist/$VERSION/$CLI_OUT"
          chmod +x "dist/$VERSION/$CLI_OUT"
          (cd "dist/$VERSION" && tar -czf "$CLI_OUT.tar.gz" "$CLI_OUT")

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-cli-linux-x86_64
          path: dist/${{ steps.vars.outputs.version }}/*.tar.gz
          if-no-files-found: error

  build_cli_windows_x86_64:
    name: Build CLI Windows x86_64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${{ github.event.inputs.version_tag }}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-pc-windows-gnu

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: cli-windows-x86_64
          cache-on-failure: true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends zip mingw-w64

      - name: Install cross
        shell: bash
        run: |
          set -euo pipefail
          cargo install cross --locked

      - name: Build CLI windows-x86_64
        shell: bash
        env:
          CROSS_CONTAINER_ENGINE_NO_BUILDKIT: "0"
        run: |
          set -euo pipefail
          cross build \
            --profile release-dist \
            --target x86_64-pc-windows-gnu \
            --bin kalam

      - name: Package CLI artifact
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION
          CLI_OUT="kalamcli-${VERSION}-windows-x86_64.exe"
          cp "target/x86_64-pc-windows-gnu/release-dist/kalam.exe" "dist/$VERSION/$CLI_OUT"
          CROSS_IMAGE="ghcr.io/cross-rs/x86_64-pc-windows-gnu:latest"
          docker run --rm -v "$PWD":/work "$CROSS_IMAGE" bash -lc "\
            set -euo pipefail; \
            DLL_DIR=/usr/x86_64-w64-mingw32/bin; \
            for dll in libstdc++-6.dll libgcc_s_seh-1.dll libwinpthread-1.dll; do \
              if [[ ! -f \"$DLL_DIR/$dll\" ]]; then \
                echo \"Missing $dll in $DLL_DIR\" >&2; \
                exit 1; \
              fi; \
              cp \"$DLL_DIR/$dll\" \"/work/dist/$VERSION/\"; \
            done"
          (cd "dist/$VERSION" && zip -q "${CLI_OUT%.exe}.zip" "$CLI_OUT" libstdc++-6.dll libgcc_s_seh-1.dll libwinpthread-1.dll)

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-cli-windows-x86_64
          path: dist/${{ steps.vars.outputs.version }}/*.zip
          if-no-files-found: error

  build_cli_macos_arm:
    name: Build CLI macOS ARM
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${{ github.event.inputs.version_tag }}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-apple-darwin

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: cli-macos-aarch64
          cache-on-failure: true

      - name: Install LLVM (fix libclang.dylib)
        shell: bash
        run: |
          set -euo pipefail
          brew install llvm@16
          echo "LIBCLANG_PATH=$(brew --prefix llvm@16)/lib" >> "$GITHUB_ENV"
          echo "LLVM_CONFIG_PATH=$(brew --prefix llvm@16)/bin/llvm-config" >> "$GITHUB_ENV"

      - name: Build CLI macos-aarch64
        shell: bash
        run: |
          set -euo pipefail
          cargo build \
            --profile release-dist \
            --target aarch64-apple-darwin \
            --bin kalam

      - name: Package CLI artifact
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION
          CLI_OUT="kalamcli-${VERSION}-macos-aarch64"
          cp "target/aarch64-apple-darwin/release-dist/kalam" "dist/$VERSION/$CLI_OUT"
          chmod +x "dist/$VERSION/$CLI_OUT"
          (cd "dist/$VERSION" && tar -czf "$CLI_OUT.tar.gz" "$CLI_OUT")

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-cli-macos-arm
          path: dist/${{ steps.vars.outputs.version }}/*.tar.gz
          if-no-files-found: error

  build_linux_x86_64:
    name: Build Server Linux x86_64
    runs-on: ubuntu-22.04
    needs: build_ui
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}
      PLATFORMS_INPUT: ${{ github.event.inputs.platforms }}
      ALL_PLATFORMS_INPUT: ${{ github.event.inputs.all_platforms }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"

          # Determine requested platforms for this run
          PLATFORMS_INPUT="${PLATFORMS_INPUT:-}"
          if [[ -z "${PLATFORMS_INPUT}" ]]; then
            PLATFORMS_INPUT="${{ env.DEFAULT_PLATFORMS }}"
          fi
          if [[ "${{ github.event_name }}" == "push" ]]; then
            PLATFORMS_INPUT="${{ env.DEFAULT_PLATFORMS }}"
          fi
          if [[ "${ALL_PLATFORMS_INPUT:-}" == "true" ]]; then
            PLATFORMS_INPUT="linux-x86_64,linux-aarch64,macos-x86_64,macos-aarch64,windows-x86_64"
          fi

          BUILD_LINUX=false
          if [[ "$PLATFORMS_INPUT" == *"linux-x86_64"* ]]; then BUILD_LINUX=true; fi

          {
            echo "platforms=$PLATFORMS_INPUT"
            echo "build_linux=$BUILD_LINUX"
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Download UI dist
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

      - name: Setup Rust
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-unknown-linux-gnu

      - name: Cache Rust
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: server-linux-x86_64-ubuntu-22-04
          cache-on-failure: true

      - name: Install system deps
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang \
            libclang-dev \
            pkg-config \
            libssl-dev

      - name: Build linux-x86_64 (release-dist)
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        shell: bash
        env:
          SKIP_UI_BUILD: "1"
        run: |
          set -euo pipefail
          cargo build \
            --profile release-dist \
            --target x86_64-unknown-linux-gnu \
            --bin kalamdb-server

      - name: Package linux artifacts
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION

          SRV_OUT="kalamdb-server-${VERSION}-linux-x86_64"

          cp "target/x86_64-unknown-linux-gnu/release-dist/kalamdb-server" "dist/$VERSION/$SRV_OUT"
          chmod +x "dist/$VERSION/$SRV_OUT"

          (cd "dist/$VERSION" && tar -czf "$SRV_OUT.tar.gz" "$SRV_OUT")

      - name: Upload artifacts
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-x86_64
          path: dist/${{ steps.vars.outputs.version }}/*
          if-no-files-found: error

  build_linux_aarch64:
    name: Build Server Linux ARM64
    runs-on: ubuntu-latest
    needs: build_ui
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}
      PLATFORMS_INPUT: ${{ github.event.inputs.platforms }}
      ALL_PLATFORMS_INPUT: ${{ github.event.inputs.all_platforms }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"

          # Always build linux-aarch64 for Docker multi-arch support
          BUILD_LINUX_ARM=true

          {
            echo "build_linux_arm=$BUILD_LINUX_ARM"
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Download UI dist
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

      - name: Setup Rust
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-unknown-linux-gnu

      - name: Cache Rust
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: server-linux-aarch64
          cache-on-failure: true

      - name: Install cross
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          cargo install cross --locked

      - name: Build linux-aarch64 (cross, docker profile)
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        shell: bash
        env:
          CROSS_CONTAINER_ENGINE_NO_BUILDKIT: "0"
          SKIP_UI_BUILD: "1"
        run: |
          set -euo pipefail
          cross build \
            --profile docker \
            --target aarch64-unknown-linux-gnu \
            --bin kalamdb-server

      - name: Package linux-aarch64 artifacts
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION

          SRV_OUT="kalamdb-server-${VERSION}-linux-aarch64"

          cp "target/aarch64-unknown-linux-gnu/docker/kalamdb-server" "dist/$VERSION/$SRV_OUT"
          chmod +x "dist/$VERSION/$SRV_OUT"

          (cd "dist/$VERSION" && tar -czf "$SRV_OUT.tar.gz" "$SRV_OUT")

      - name: Upload artifacts
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-aarch64
          path: dist/${{ steps.vars.outputs.version }}/*
          if-no-files-found: error

  build_cli_linux_aarch64:
    name: Build CLI Linux ARM64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${{ github.event.inputs.version_tag }}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-unknown-linux-gnu

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: cli-linux-aarch64
          cache-on-failure: true

      - name: Install cross
        shell: bash
        run: |
          set -euo pipefail
          cargo install cross --locked

      - name: Build CLI linux-aarch64
        shell: bash
        env:
          CROSS_CONTAINER_ENGINE_NO_BUILDKIT: "0"
        run: |
          set -euo pipefail
          cross build \
            --profile docker \
            --target aarch64-unknown-linux-gnu \
            --bin kalam

      - name: Package CLI artifact
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION
          CLI_OUT="kalamcli-${VERSION}-linux-aarch64"
          cp "target/aarch64-unknown-linux-gnu/docker/kalam" "dist/$VERSION/$CLI_OUT"
          chmod +x "dist/$VERSION/$CLI_OUT"
          (cd "dist/$VERSION" && tar -czf "$CLI_OUT.tar.gz" "$CLI_OUT")

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-cli-linux-aarch64
          path: dist/${{ steps.vars.outputs.version }}/*.tar.gz
          if-no-files-found: error

  build_windows_x86_64:
    name: Build Windows x86_64
    runs-on: ubuntu-latest
    needs: build_ui
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}
      PLATFORMS_INPUT: ${{ github.event.inputs.platforms }}
      ALL_PLATFORMS_INPUT: ${{ github.event.inputs.all_platforms }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"

          PLATFORMS_INPUT="${PLATFORMS_INPUT:-}"
          if [[ -z "${PLATFORMS_INPUT}" ]]; then
            PLATFORMS_INPUT="${{ env.DEFAULT_PLATFORMS }}"
          fi
          if [[ "${{ github.event_name }}" == "push" ]]; then
            PLATFORMS_INPUT="${{ env.DEFAULT_PLATFORMS }}"
          fi
          if [[ "${ALL_PLATFORMS_INPUT:-}" == "true" ]]; then
            PLATFORMS_INPUT="linux-x86_64,linux-aarch64,macos-x86_64,macos-aarch64,windows-x86_64"
          fi

          BUILD_WINDOWS=false
          if [[ "$PLATFORMS_INPUT" == *"windows-x86_64"* ]]; then BUILD_WINDOWS=true; fi

          {
            echo "platforms=$PLATFORMS_INPUT"
            echo "build_windows=$BUILD_WINDOWS"
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Download UI dist
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

      - name: Setup Rust
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-pc-windows-gnu

      - name: Cache Rust
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: server-windows-x86_64
          cache-on-failure: true

      - name: Install system deps
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends zip mingw-w64

      - name: Install cross
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          cargo install cross --locked

      - name: Build windows-x86_64 (cross, release-dist profile)
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        shell: bash
        env:
          CROSS_CONTAINER_ENGINE_NO_BUILDKIT: "0"
          SKIP_UI_BUILD: "1"
        run: |
          set -euo pipefail
          cross build \
            --profile release-dist \
            --target x86_64-pc-windows-gnu \
            --bin kalamdb-server

      - name: Package windows artifacts
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION

          SRV_OUT="kalamdb-server-${VERSION}-windows-x86_64.exe"

          cp "target/x86_64-pc-windows-gnu/release-dist/kalamdb-server.exe" "dist/$VERSION/$SRV_OUT"
          DLL_DIR="/usr/x86_64-w64-mingw32/bin"
          for dll in libstdc++-6.dll libgcc_s_seh-1.dll libwinpthread-1.dll; do
            if [[ ! -f "$DLL_DIR/$dll" ]]; then
              echo "Missing $dll in $DLL_DIR" >&2
              exit 1
            fi
            cp "$DLL_DIR/$dll" "dist/$VERSION/"
          done

          (cd "dist/$VERSION" && zip -q "${SRV_OUT%.exe}.zip" "$SRV_OUT" libstdc++-6.dll libgcc_s_seh-1.dll libwinpthread-1.dll)

      - name: Upload artifacts
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows-x86_64
          path: dist/${{ steps.vars.outputs.version }}/*
          if-no-files-found: error

  build_macos_arm:
    name: Build macOS ARM
    runs-on: macos-14
    needs: build_ui
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}
      PLATFORMS_INPUT: ${{ github.event.inputs.platforms }}
      ALL_PLATFORMS_INPUT: ${{ github.event.inputs.all_platforms }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"

          PLATFORMS_INPUT="${PLATFORMS_INPUT:-}"
          if [[ -z "${PLATFORMS_INPUT}" ]]; then
            PLATFORMS_INPUT="${{ env.DEFAULT_PLATFORMS }}"
          fi
          if [[ "${{ github.event_name }}" == "push" ]]; then
            PLATFORMS_INPUT="${{ env.DEFAULT_PLATFORMS }}"
          fi
          if [[ "${ALL_PLATFORMS_INPUT:-}" == "true" ]]; then
            PLATFORMS_INPUT="linux-x86_64,linux-aarch64,macos-x86_64,macos-aarch64,windows-x86_64"
          fi

          BUILD_MACOS=false
          if [[ "$PLATFORMS_INPUT" == *"macos-aarch64"* ]]; then BUILD_MACOS=true; fi

          {
            echo "platforms=$PLATFORMS_INPUT"
            echo "build_macos=$BUILD_MACOS"
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Download UI dist
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

      - name: Setup Rust
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-apple-darwin

      - name: Cache Rust
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: server-macos-aarch64
          cache-on-failure: true

      - name: Install LLVM (fix libclang.dylib)
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          brew install llvm@16
          echo "LIBCLANG_PATH=$(brew --prefix llvm@16)/lib" >> "$GITHUB_ENV"
          echo "LLVM_CONFIG_PATH=$(brew --prefix llvm@16)/bin/llvm-config" >> "$GITHUB_ENV"

      - name: Build macos-aarch64 (release-dist)
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        shell: bash
        env:
          SKIP_UI_BUILD: "1"
        run: |
          set -euo pipefail
          cargo build \
            --profile release-dist \
            --target aarch64-apple-darwin \
            --bin kalamdb-server

      - name: Smoke test macOS ARM server
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          cp backend/server.example.toml server.toml

          sed -i '' 's|rocksdb_path = "./data/rocksdb"|rocksdb_path = "./test-data/rocksdb"|g' server.toml
          sed -i '' 's|default_storage_path = "./data/storage"|default_storage_path = "./test-data/storage"|g' server.toml
          sed -i '' 's|logs_path = "./logs"|logs_path = "./test-data/logs"|g' server.toml
          sed -i '' 's|jwt_secret = ".*"|jwt_secret = "smoke-test-secret-key-minimum-32-characters-long-for-ci"|g' server.toml

          mkdir -p test-data/rocksdb test-data/storage test-data/logs

          ./target/aarch64-apple-darwin/release-dist/kalamdb-server &
          SERVER_PID=$!

          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/v1/api/healthcheck > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "Server process died"
              exit 1
            fi
            echo "Waiting... ($i/30)"
            sleep 1
          done

          if ! curl -s http://localhost:8080/v1/api/healthcheck > /dev/null 2>&1; then
            echo "Server failed to start within 30 seconds"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi

          kill $SERVER_PID 2>/dev/null || true

      - name: Package macOS artifacts
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION

          SRV_OUT="kalamdb-server-${VERSION}-macos-aarch64"

          cp "target/aarch64-apple-darwin/release-dist/kalamdb-server" "dist/$VERSION/$SRV_OUT"
          chmod +x "dist/$VERSION/$SRV_OUT"

          (cd "dist/$VERSION" && tar -czf "$SRV_OUT.tar.gz" "$SRV_OUT")

      - name: Upload artifacts (macos arm)
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: dist-macos-arm
          path: dist/${{ steps.vars.outputs.version }}/*
          if-no-files-found: error

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # SMOKE TESTS - Run after Linux builds complete
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  smoke_tests:
    name: Smoke Tests (Linux x86_64)
    runs-on: ubuntu-latest
    needs:
      - build_linux_x86_64
      - build_cli_linux_x86_64
    # Continue even if tests fail - will be marked as warning
    continue-on-error: true
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download server binary
        uses: actions/download-artifact@v4
        with:
          name: dist-linux-x86_64
          path: dist/

      - name: Download CLI binary
        uses: actions/download-artifact@v4
        with:
          name: dist-cli-linux-x86_64
          path: dist/

      - name: Setup Rust (for running tests)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: smoke-tests
          cache-on-failure: true

      - name: Prepare binaries
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          
          # Extract all tar.gz archives
          find dist -name "*.tar.gz" -type f -exec tar -xzf {} -C dist/ \;
          
          # List extracted files
          echo "Files in dist/ after extraction:"
          ls -la dist/
          
          # Find and make server executable
          SERVER_BIN=$(find dist -name "kalamdb-server-*-linux-x86_64" -type f ! -name "*.tar.gz" | head -1)
          if [[ -z "$SERVER_BIN" ]]; then
            echo "Server binary not found in dist/"
            exit 1
          fi
          chmod +x "$SERVER_BIN"
          cp "$SERVER_BIN" ./kalamdb-server
          
          # Find and make CLI executable  
          CLI_BIN=$(find dist -name "kalamcli-*-linux-x86_64" -type f ! -name "*.tar.gz" | head -1)
          if [[ -z "$CLI_BIN" ]]; then
            echo "CLI binary not found in dist/"
            exit 1
          fi
          chmod +x "$CLI_BIN"
          cp "$CLI_BIN" ./kalamcli
          
          echo "Server binary: $SERVER_BIN"
          echo "CLI binary: $CLI_BIN"
          ls -la ./kalamdb-server ./kalamcli

      - name: Create server config
        shell: bash
        run: |
          # Copy the example config as base
          cp backend/server.example.toml server.toml
          
          # Update paths and jwt_secret for smoke tests
          sed -i 's|rocksdb_path = "./data/rocksdb"|rocksdb_path = "./test-data/rocksdb"|g' server.toml
          sed -i 's|default_storage_path = "./data/storage"|default_storage_path = "./test-data/storage"|g' server.toml
          sed -i 's|logs_path = "./logs"|logs_path = "./test-data/logs"|g' server.toml
          sed -i 's|jwt_secret = ".*"|jwt_secret = "smoke-test-secret-key-minimum-32-characters-long-for-ci"|g' server.toml
          
          # Increase rate limits for smoke tests
          sed -i 's|max_queries_per_sec = 1000|max_queries_per_sec = 10000|g' server.toml
          sed -i 's|max_messages_per_sec = 500|max_messages_per_sec = 1000|g' server.toml
          
          # Verify the config
          echo "=== server.toml ==="
          cat server.toml | head -100

      - name: Start server
        shell: bash
        run: |
          set -euo pipefail
          # Create required directories
          mkdir -p test-data/rocksdb test-data/storage test-data/logs
          
          # Start server in background
          ./kalamdb-server &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> "$GITHUB_ENV"
          
          # Wait for server to be ready
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/health > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "Server process died"
              exit 1
            fi
            echo "Waiting... ($i/30)"
            sleep 1
          done
          
          # Final check
          if ! curl -s http://localhost:8080/health > /dev/null 2>&1; then
            echo "Server failed to start within 30 seconds"
            exit 1
          fi

      - name: Run smoke tests
        id: smoke_tests
        shell: bash
        run: |
          set -euo pipefail
          cd cli
          
          # Run smoke tests and capture result
          # Using --test-threads=1 for sequential execution
          if cargo test --features e2e-tests --test smoke -- --test-threads=1 2>&1 | tee ../smoke-test-output.txt; then
            echo "smoke_tests_passed=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ All smoke tests passed!"
          else
            echo "smoke_tests_passed=false" >> "$GITHUB_OUTPUT"
            echo "‚ö†Ô∏è Some smoke tests failed (marked as warning)"
            # Don't exit with error - continue-on-error handles this
          fi

      - name: Stop server
        if: always()
        shell: bash
        run: |
          if [[ -n "${SERVER_PID:-}" ]]; then
            kill $SERVER_PID 2>/dev/null || true
            echo "Server stopped"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: smoke-test-output.txt
          if-no-files-found: ignore

      - name: Report test status
        if: always()
        shell: bash
        run: |
          if [[ "${{ steps.smoke_tests.outputs.smoke_tests_passed }}" == "true" ]]; then
            echo "::notice::‚úÖ Smoke tests passed successfully"
          else
            echo "::warning::‚ö†Ô∏è Some smoke tests failed - review smoke-test-results artifact for details"
          fi

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - build_cli_linux_x86_64
      - build_cli_linux_aarch64
      - build_cli_windows_x86_64
      - build_cli_macos_arm
      - build_linux_x86_64
      - build_linux_aarch64
      - build_windows_x86_64
      - build_macos_arm

    if: ${{ github.event_name == 'push' || github.event.inputs.github_release == 'true' }}
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          {
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Update README latest release
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.vars.outputs.tag }}"

          git fetch origin main
          git checkout main

          sed -i "s/^\*\*Latest release:\*\* .*/**Latest release:** ${TAG}/" README.md

          if git diff --quiet; then
            echo "README already up to date"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: update latest release"
          git push origin main

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: 'dist-*'

      - name: Generate SHA256SUMS
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p "dist/$VERSION"

          # Flatten artifacts into dist/<version>/
          find release-assets -type f -maxdepth 4 -print0 | while IFS= read -r -d '' f; do
            cp "$f" "dist/$VERSION/"
          done

          cd "dist/$VERSION"
          if ! ls -1 ./*.tar.gz ./*.zip >/dev/null 2>&1; then
            echo "No release artifacts found. Check workflow inputs.platforms / all_platforms." >&2
            exit 1
          fi
          sha256sum ./*.tar.gz ./*.zip > SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          generate_release_notes: true
          files: |
            dist/${{ steps.vars.outputs.version }}/*.tar.gz
            dist/${{ steps.vars.outputs.version }}/*.zip
            dist/${{ steps.vars.outputs.version }}/SHA256SUMS

  docker:
    name: Push Docker image (Docker Hub)
    runs-on: ubuntu-latest
    needs:
      - build_cli_linux_x86_64
      - build_cli_linux_aarch64
      - build_linux_x86_64
      - build_linux_aarch64

    if: ${{ github.event_name == 'push' || github.event.inputs.docker_push == 'true' }}
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}
      DOCKER_REPO_INPUT: ${{ github.event.inputs.docker_repo }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          {
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

          DOCKER_REPO="${DOCKER_REPO_INPUT:-}"
          if [[ -z "$DOCKER_REPO" ]]; then
            DOCKER_REPO="jamals86/kalamdb"
          fi
          echo "docker_repo=$DOCKER_REPO" >> "$GITHUB_OUTPUT"

      - name: Download pre-built artifacts (x86_64)
        uses: actions/download-artifact@v4
        with:
          name: dist-linux-x86_64
          path: artifacts/server-amd64

      - name: Download pre-built CLI artifact (x86_64)
        uses: actions/download-artifact@v4
        with:
          name: dist-cli-linux-x86_64
          path: artifacts/cli-amd64

      - name: Download pre-built artifacts (aarch64)
        uses: actions/download-artifact@v4
        with:
          name: dist-linux-aarch64
          path: artifacts/server-arm64

      - name: Download pre-built CLI artifact (aarch64)
        uses: actions/download-artifact@v4
        with:
          name: dist-cli-linux-aarch64
          path: artifacts/cli-arm64

      - name: Extract and prepare binaries (amd64)
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p binaries-amd64

          # Extract server binary
          tar -xzf "artifacts/server-amd64/kalamdb-server-${VERSION}-linux-x86_64.tar.gz" -C binaries-amd64
          mv "binaries-amd64/kalamdb-server-${VERSION}-linux-x86_64" binaries-amd64/kalamdb-server

          # Extract CLI binary
          tar -xzf "artifacts/cli-amd64/kalamcli-${VERSION}-linux-x86_64.tar.gz" -C binaries-amd64
          mv "binaries-amd64/kalamcli-${VERSION}-linux-x86_64" binaries-amd64/kalam

          chmod +x binaries-amd64/kalamdb-server binaries-amd64/kalam
          ls -la binaries-amd64/

      - name: Extract and prepare binaries (arm64)
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p binaries-arm64

          # Extract server binary
          tar -xzf "artifacts/server-arm64/kalamdb-server-${VERSION}-linux-aarch64.tar.gz" -C binaries-arm64
          mv "binaries-arm64/kalamdb-server-${VERSION}-linux-aarch64" binaries-arm64/kalamdb-server

          # Extract CLI binary
          tar -xzf "artifacts/cli-arm64/kalamcli-${VERSION}-linux-aarch64.tar.gz" -C binaries-arm64
          mv "binaries-arm64/kalamcli-${VERSION}-linux-aarch64" binaries-arm64/kalam

          chmod +x binaries-arm64/kalamdb-server binaries-arm64/kalam
          ls -la binaries-arm64/

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image (linux/amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/build/Dockerfile.prebuilt
          push: true
          platforms: linux/amd64
          build-contexts: |
            binaries=binaries-amd64
          tags: |
            ${{ steps.vars.outputs.docker_repo }}:${{ steps.vars.outputs.version }}-amd64

      - name: Test Docker image (linux/amd64)
        shell: bash
        run: |
          set -euo pipefail
          
          # Pull the just-built image
          docker pull ${{ steps.vars.outputs.docker_repo }}:${{ steps.vars.outputs.version }}-amd64
          
          # Run smoke test
          chmod +x docker/build/test-docker-image.sh
          ./docker/build/test-docker-image.sh ${{ steps.vars.outputs.docker_repo }}:${{ steps.vars.outputs.version }}-amd64

      - name: Build and push Docker image (linux/arm64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/build/Dockerfile.prebuilt
          push: true
          platforms: linux/arm64
          build-contexts: |
            binaries=binaries-arm64
          tags: |
            ${{ steps.vars.outputs.docker_repo }}:${{ steps.vars.outputs.version }}-arm64

      - name: Create and push multi-arch manifest
        shell: bash
        run: |
          set -euo pipefail
          REPO="${{ steps.vars.outputs.docker_repo }}"
          VERSION="${{ steps.vars.outputs.version }}"

          # Create manifest for versioned tag
          docker buildx imagetools create -t "${REPO}:${VERSION}" \
            "${REPO}:${VERSION}-amd64" \
            "${REPO}:${VERSION}-arm64"

          # Create manifest for latest tag
          docker buildx imagetools create -t "${REPO}:latest" \
            "${REPO}:${VERSION}-amd64" \
            "${REPO}:${VERSION}-arm64"

          echo "‚úÖ Multi-arch manifest created for ${REPO}:${VERSION} and ${REPO}:latest"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # NPM PUBLISH - Publish TypeScript SDK to npm registry
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  publish_npm:
    name: Publish TypeScript SDK to npm
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || github.event.inputs.npm_publish == 'true' }}
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        shell: bash
        run: |
          curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: npm-publish
          cache-on-failure: true

      - name: Build TypeScript SDK
        shell: bash
        working-directory: link/sdks/typescript
        run: |
          set -euo pipefail
          echo "üì¶ Installing npm dependencies..."
          npm ci || npm install
          
          echo "üî® Building SDK..."
          npm run build
          
          echo "‚úÖ SDK build complete"
          ls -la dist/

      - name: Update package version
        shell: bash
        working-directory: link/sdks/typescript
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          echo "üìù Updating package.json version to $VERSION"
          npm version "$VERSION" --no-git-tag-version --allow-same-version
          cat package.json | grep version

      - name: Publish to npm
        shell: bash
        working-directory: link/sdks/typescript
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          FORCE_PUBLISH="${{ github.event.inputs.force_npm_publish }}"
          
          echo "üöÄ Publishing kalam-link@$VERSION to npm..."
          
          # Check if this version already exists
          if npm view "kalam-link@$VERSION" version 2>/dev/null; then
            if [[ "$FORCE_PUBLISH" == "true" ]]; then
              echo "‚ö†Ô∏è  Version $VERSION exists. Force publish enabled - attempting to unpublish..."
              if npm unpublish "kalam-link@$VERSION" --force 2>/dev/null; then
                echo "‚úÖ Successfully unpublished kalam-link@$VERSION"
                npm publish --access public
                echo "‚úÖ Successfully republished kalam-link@$VERSION to npm!"
              else
                echo "‚ùå Failed to unpublish (version may be >72 hours old)"
                echo "üí° Tip: npm doesn't allow unpublishing after 72 hours."
                echo "    Use a different version number (e.g., ${VERSION}.1, ${VERSION}.2)"
                exit 1
              fi
            else
              echo "‚ö†Ô∏è  Version $VERSION already exists on npm, skipping publish"
              echo "üí° To force republish, enable 'force_npm_publish' workflow input"
            fi
          else
            npm publish --access public
            echo "‚úÖ Successfully published kalam-link@$VERSION to npm!"
          fi
