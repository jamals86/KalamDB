# KalamDB TypeScript/JavaScript SDK

The official TypeScript/JavaScript SDK for KalamDB, built on top of a Rust → WASM core.

- **Tiny bundle size** with minimal dependencies
- **Cross-platform**: Works in Node.js and browsers
- **Type-safe**: Full TypeScript support with complete type definitions
- **Real-time**: WebSocket subscriptions with Firebase/Supabase-style API

## Installation

```bash
npm install @kalamdb/client
# or
yarn add @kalamdb/client
# or
pnpm add @kalamdb/client
```

## Quick Start

```typescript
import { createClient } from '@kalamdb/client';

// Create and connect
const client = createClient({
  url: 'http://localhost:8080',
  username: 'admin',
  password: 'admin'
});
await client.connect();

// Query data
const result = await client.query('SELECT * FROM app.users LIMIT 10');
console.log(result.results[0].rows);

// Subscribe to live changes
const unsubscribe = await client.subscribe('app.messages', (event) => {
  if (event.type === 'change') {
    console.log('New data:', event.rows);
  }
});

// Later: cleanup
await unsubscribe();
await client.disconnect();
```

## API Reference

### Creating a Client

```typescript
import { KalamDBClient, createClient } from '@kalamdb/client';

// Option 1: Factory function
const client = createClient({
  url: 'http://localhost:8080',
  username: 'admin',
  password: 'admin'
});

// Option 2: Constructor
const client = new KalamDBClient('http://localhost:8080', 'admin', 'admin');
```

### Connection Management

```typescript
// Connect to server (establishes WebSocket for subscriptions)
await client.connect();

// Check connection status
if (client.isConnected()) {
  console.log('Connected!');
}

// Disconnect (closes WebSocket and cleans up subscriptions)
await client.disconnect();
```

### SQL Queries

Execute any SQL statement - SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, etc.

```typescript
// SELECT query
const result = await client.query('SELECT * FROM app.users WHERE active = true');
console.log(result.results[0].rows);

// INSERT
await client.query(`
  INSERT INTO app.users (id, name, email)
  VALUES (1, 'Alice', 'alice@example.com')
`);

// UPDATE
await client.query(`
  UPDATE app.users SET active = false WHERE id = 1
`);

// DELETE
await client.query('DELETE FROM app.users WHERE id = 1');

// DDL
await client.query(`
  CREATE TABLE app.products (
    id BIGINT PRIMARY KEY,
    name TEXT NOT NULL,
    price DOUBLE
  )
`);
```

#### Query Response Structure

```typescript
interface QueryResponse {
  status: 'success' | 'error';
  results: QueryResult[];
  took?: number;  // Execution time in milliseconds
  error?: ErrorDetail;
}

interface QueryResult {
  rows?: Record<string, any>[];
  row_count: number;
  columns: string[];
  message?: string;
}
```

### Convenience Methods

```typescript
// Insert data (builds INSERT statement automatically)
await client.insert('app.todos', {
  title: 'Buy groceries',
  completed: false
});

// Delete by ID
await client.delete('app.todos', '123456789');
```

## Real-Time Subscriptions

KalamDB uses a single WebSocket connection for all subscriptions. The subscription API follows modern patterns similar to Firebase and Supabase.

### Basic Subscription

```typescript
// Subscribe returns an unsubscribe function
const unsubscribe = await client.subscribe('app.messages', (event) => {
  switch (event.type) {
    case 'subscription_ack':
      console.log('Subscription confirmed');
      break;
    
    case 'initial_data_batch':
      console.log('Initial data:', event.rows);
      console.log('Batch info:', event.batch_control);
      break;
    
    case 'change':
      console.log(`${event.change_type}:`, event.rows);
      break;
    
    case 'error':
      console.error('Error:', event.message);
      break;
  }
});

// Later: stop receiving updates
await unsubscribe();
```

### Subscription with Options

Control how initial data is loaded using subscription options:

```typescript
// Subscribe with batch size option
const unsubscribe = await client.subscribe('app.messages', handleEvent, {
  batch_size: 100  // Load initial data in batches of 100 rows
});
```

### Subscribe to SQL Query

For more control, use `subscribeWithSql()` to subscribe to custom SQL queries:

```typescript
// Subscribe to filtered query
const unsubscribe = await client.subscribeWithSql(
  'SELECT * FROM chat.messages WHERE conversation_id = 1 ORDER BY created_at DESC',
  (event) => {
    if (event.type === 'change') {
      console.log('New message:', event.rows);
    }
  },
  { batch_size: 50 }
);
```

### Subscription Management

```typescript
// Get number of active subscriptions
const count = client.getSubscriptionCount();
console.log(`Active subscriptions: ${count}`);

// Get details about all subscriptions
const subscriptions = client.getSubscriptions();
for (const sub of subscriptions) {
  console.log(`ID: ${sub.id}, Table: ${sub.tableName}, Since: ${sub.createdAt}`);
}

// Check if subscribed to a specific table
if (!client.isSubscribedTo('app.messages')) {
  await client.subscribe('app.messages', handleChanges);
}

// Unsubscribe from all at once
await client.unsubscribeAll();
```

### Preventing Too Many Subscriptions

```typescript
const MAX_SUBSCRIPTIONS = 10;

async function subscribeToTable(tableName: string) {
  if (client.getSubscriptionCount() >= MAX_SUBSCRIPTIONS) {
    console.warn('Too many subscriptions! Unsubscribe from unused tables first.');
    return null;
  }
  
  return await client.subscribe(tableName, handleEvent);
}
```

### Server Message Types

```typescript
type ServerMessage =
  | {
      type: 'subscription_ack';
      subscription_id: string;
      total_rows: number;
      batch_control: BatchControl;
    }
  | {
      type: 'initial_data_batch';
      subscription_id: string;
      rows: Record<string, any>[];
      batch_control: BatchControl;
    }
  | {
      type: 'change';
      subscription_id: string;
      change_type: 'insert' | 'update' | 'delete';
      rows?: Record<string, any>[];
      old_values?: Record<string, any>[];
    }
  | {
      type: 'error';
      subscription_id: string;
      code: string;
      message: string;
    };

interface BatchControl {
  batch_num: number;
  total_batches?: number;
  has_more: boolean;
  status: 'loading' | 'loading_batch' | 'ready';
  last_seq_id?: string;
  snapshot_end_seq?: string;
}
```

## Browser Usage

```html
<!DOCTYPE html>
<html>
<head>
  <title>KalamDB Example</title>
</head>
<body>
  <div id="messages"></div>
  
  <script type="module">
    import { createClient } from '/path/to/dist/index.js';
    
    const client = createClient({
      url: 'http://localhost:8080',
      username: 'admin',
      password: 'admin'
    });
    
    await client.connect();
    
    const unsubscribe = await client.subscribe('app.messages', (event) => {
      if (event.type === 'change' && event.rows) {
        const div = document.getElementById('messages');
        for (const row of event.rows) {
          div.innerHTML += `<p>${JSON.stringify(row)}</p>`;
        }
      }
    });
  </script>
</body>
</html>
```

## Node.js Usage

For Node.js, you need a WebSocket polyfill since Node.js doesn't have native WebSocket:

```typescript
// Install: npm install ws
import WebSocket from 'ws';

// Add to global before importing KalamDB client
(global as any).WebSocket = WebSocket;

import { createClient } from '@kalamdb/client';

const client = createClient({
  url: 'http://localhost:8080',
  username: 'admin',
  password: 'admin'
});

await client.connect();
// ... use client
await client.disconnect();
```

## Complete Example: Chat Application

```typescript
import { createClient, ServerMessage } from '@kalamdb/client';

async function main() {
  const client = createClient({
    url: 'http://localhost:8080',
    username: 'admin',
    password: 'admin'
  });
  
  await client.connect();
  console.log('Connected to KalamDB');
  
  // Create messages table (STREAM for auto-expiring data)
  await client.query(`
    CREATE STREAM IF NOT EXISTS app.messages
    TTL_SECONDS = 86400
    (
      id BIGINT PRIMARY KEY,
      user_id TEXT,
      content TEXT,
      created_at TIMESTAMP
    )
  `);
  
  // Subscribe to new messages
  const unsubscribe = await client.subscribe('app.messages', (event: ServerMessage) => {
    if (event.type === 'change' && event.change_type === 'insert') {
      console.log('New message:', event.rows);
    }
  });
  
  console.log(`Active subscriptions: ${client.getSubscriptionCount()}`);
  
  // Insert a message
  await client.insert('app.messages', {
    id: Date.now(),
    user_id: 'alice',
    content: 'Hello, world!',
    created_at: new Date().toISOString()
  });
  
  // Keep running for 30 seconds
  await new Promise(resolve => setTimeout(resolve, 30000));
  
  // Cleanup
  await unsubscribe();
  await client.disconnect();
  console.log('Disconnected');
}

main().catch(console.error);
```

## Error Handling

```typescript
try {
  await client.connect();
} catch (error) {
  console.error('Connection failed:', error);
}

try {
  const result = await client.query('SELECT * FROM nonexistent_table');
} catch (error) {
  console.error('Query failed:', error);
}

// Handle subscription errors in callback
await client.subscribe('app.data', (event) => {
  if (event.type === 'error') {
    console.error(`Subscription error [${event.code}]: ${event.message}`);
    // Optionally: reconnect or notify user
  }
});
```

## TypeScript Types

All types are exported for use in your TypeScript code:

```typescript
import {
  // Client
  KalamDBClient,
  ClientOptions,
  
  // Query types
  QueryResult,
  QueryResponse,
  ErrorDetail,
  
  // Subscription types
  ServerMessage,
  BatchControl,
  SubscriptionCallback,
  SubscriptionInfo,
  SubscribeOptions,
  Unsubscribe
} from '@kalamdb/client';
```

## Architecture

The SDK is built on a Rust core compiled to WebAssembly:

```
┌─────────────────────────────────────┐
│     TypeScript/JavaScript API       │
│    (index.ts - type-safe wrapper)   │
└───────────────┬─────────────────────┘
                │
┌───────────────▼─────────────────────┐
│         WASM Bindings               │
│    (kalam_link.js / .wasm)          │
└───────────────┬─────────────────────┘
                │
┌───────────────▼─────────────────────┐
│         Rust Core                   │
│    (wasm.rs - WebSocket, HTTP)      │
└─────────────────────────────────────┘
```

- **Single WebSocket connection** shared by all subscriptions
- **HTTP Basic Auth** for API requests
- **WebSocket authentication** on connect
- **Subscription callbacks** stored in HashMap for efficient dispatch
