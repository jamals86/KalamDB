name: CI

permissions:
  contents: write

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: "1.92.0"

jobs:
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    if: false  # Only run on manual trigger
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt

      - name: Run rustfmt
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy Check
    runs-on: ubuntu-latest
    if: false  # Only run on manual trigger
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang \
            libclang-dev \
            pkg-config \
            libssl-dev

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-target-

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # test:
  #   name: Test Suite
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Install Rust toolchain
  #       uses: dtolnay/rust-toolchain@stable
  #       with:
  #         toolchain: ${{ env.RUST_VERSION }}

  #     - name: Install system dependencies
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y --no-install-recommends \
  #           clang \
  #           libclang-dev \
  #           pkg-config \
  #           libssl-dev

  #     - name: Cache cargo registry
  #       uses: actions/cache@v4
  #       with:
  #         path: ~/.cargo/registry
  #         key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-cargo-registry-

  #     - name: Cache cargo index
  #       uses: actions/cache@v4
  #       with:
  #         path: ~/.cargo/git
  #         key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-cargo-index-

  #     - name: Cache cargo build
  #       uses: actions/cache@v4
  #       with:
  #         path: target
  #         key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-cargo-build-target-

  #     - name: Run tests
  #       run: cargo test --workspace --all-features

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang \
            libclang-dev \
            pkg-config \
            libssl-dev

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-target-

      - name: Install cargo-nextest
        run: |
          curl -LsSf https://get.nexte.st/latest/linux | tar zxf - -C ${CARGO_HOME:-~/.cargo}/bin

      - name: Run tests and generate badge
        run: |
          # Run tests and capture output
          cargo nextest run --workspace --no-fail-fast > test_output.txt 2>&1 || true
          cat test_output.txt
          
          # Parse the summary line from nextest output
          # Expected format: "     Summary [ 427.076s] 2204 tests run: 2203 passed, 1 failed, 90 skipped"
          # Note: nextest adds leading spaces before "Summary"
          SUMMARY=$(grep -E "^\s*Summary \[.*\] [0-9]+ tests run:" test_output.txt || echo "")
          
          if [ -z "$SUMMARY" ]; then
            echo "Error: Could not find nextest summary line"
            cat test_output.txt | tail -20
            exit 1
          fi
          
          echo "Found summary: $SUMMARY"
          
          # Extract numbers using grep with extended regex (more portable)
          TOTAL=$(echo "$SUMMARY" | grep -oE "[0-9]+ tests run" | grep -oE "[0-9]+")
          PASSED=$(echo "$SUMMARY" | grep -oE "[0-9]+ passed" | grep -oE "[0-9]+")
          FAILED=$(echo "$SUMMARY" | grep -oE "[0-9]+ failed" | grep -oE "[0-9]+")
          
          # Default to 0 if extraction failed
          PASSED=${PASSED:-0}
          FAILED=${FAILED:-0}
          TOTAL=${TOTAL:-0}
          
          echo "Tests: $PASSED passed, $FAILED failed (total: $TOTAL)"
          
          # Skip badge generation if parsing failed (total is 0 or 1)
          if [ "$TOTAL" -le "1" ]; then
            echo "Error: Invalid test count ($TOTAL). Parsing likely failed."
            exit 1
          fi
          
          # Determine badge color
          if [ "$FAILED" -eq "0" ]; then
            COLOR="brightgreen"
            MESSAGE="$PASSED/$TOTAL passed"
          else
            COLOR="red"
            MESSAGE="$PASSED/$TOTAL passed, $FAILED failed"
          fi
          
          # Generate badge JSON
          mkdir -p .github/badges
          cat > .github/badges/tests.json << EOF
          {
            "schemaVersion": 1,
            "label": "tests",
            "message": "$MESSAGE",
            "color": "$COLOR"
          }
          EOF
          
          cat .github/badges/tests.json

      - name: Commit badge
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/badges/tests.json
          git diff --staged --quiet || git commit -m "Update test badge [skip ci]"
          git push || echo "Nothing to push"
