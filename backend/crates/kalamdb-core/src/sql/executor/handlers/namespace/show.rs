//! Typed DDL handler for SHOW NAMESPACES statements

use crate::app_context::AppContext;
use crate::error::KalamDbError;
use crate::sql::executor::handlers::typed::TypedStatementHandler;
use crate::sql::context::{ExecutionContext, ExecutionResult, ScalarValue};
use kalamdb_sql::ddl::ShowNamespacesStatement;
use std::sync::Arc;

/// Typed handler for SHOW NAMESPACES statements
pub struct ShowNamespacesHandler {
    app_context: Arc<AppContext>,
}

impl ShowNamespacesHandler {
    pub fn new(app_context: Arc<AppContext>) -> Self {
        Self { app_context }
    }
}

#[async_trait::async_trait]
impl TypedStatementHandler<ShowNamespacesStatement> for ShowNamespacesHandler {
    async fn execute(
        &self,
        _statement: ShowNamespacesStatement,
        _params: Vec<ScalarValue>,
        context: &ExecutionContext,
    ) -> Result<ExecutionResult, KalamDbError> {
        let start_time = std::time::Instant::now();
        let namespaces_provider = self.app_context.system_tables().namespaces();

        // Query all namespaces via the table provider (returns RecordBatch)
        let batches = namespaces_provider.scan_all_namespaces()?;

        // Log query operation
        let duration = start_time.elapsed().as_secs_f64() * 1000.0;
        use crate::sql::executor::helpers::audit;
        let audit_entry = audit::log_query_operation(context, "SHOW", "NAMESPACES", duration, None);
        audit::persist_audit_entry(&self.app_context, &audit_entry).await?;

        // Return as query result
        let row_count = batches.num_rows();
        Ok(ExecutionResult::Rows {
            batches: vec![batches],
            row_count,
            schema: None,
        })
    }

    async fn check_authorization(
        &self,
        _statement: &ShowNamespacesStatement,
        _context: &ExecutionContext,
    ) -> Result<(), KalamDbError> {
        // SHOW NAMESPACES allowed for all authenticated users
        Ok(())
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::test_helpers::{create_test_session_simple, test_app_context_simple};
    use kalamdb_commons::models::UserId;
    use kalamdb_commons::Role;
    use std::sync::Arc;

    fn init_app_context() -> Arc<AppContext> {
        test_app_context_simple()
    }

    fn create_test_context() -> ExecutionContext {
        ExecutionContext::new(UserId::new("test_user"), Role::User, create_test_session_simple())
    }

    #[tokio::test]
    async fn test_show_namespaces_authorization() {
        let app_ctx = init_app_context();
        let handler = ShowNamespacesHandler::new(app_ctx);
        let stmt = ShowNamespacesStatement {};

        // All users can show namespaces
        let ctx = create_test_context();
        let result = handler.check_authorization(&stmt, &ctx).await;

        assert!(result.is_ok());
    }

    #[tokio::test]
    async fn test_show_namespaces_success() {
        let app_ctx = init_app_context();
        let handler = ShowNamespacesHandler::new(app_ctx);
        let stmt = ShowNamespacesStatement {};
        let ctx = create_test_context();

        let result = handler.execute(stmt, vec![], &ctx).await;

        // Should return batches
        assert!(result.is_ok());
        if let Ok(ExecutionResult::Rows { batches, .. }) = result {
            assert!(!batches.is_empty());
        }
    }
}
