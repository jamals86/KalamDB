# KalamDB Server Configuration
# This is an example configuration file with all available settings.
# Copy this file to config.toml and adjust values for your environment.
#
# NOTE: Runtime configuration only!
# - Namespace and storage location configuration is stored in system tables (via kalamdb-sql)
# - This file contains only server runtime settings (ports, paths, limits, etc.)

[server]
# Server bind address (default: 127.0.0.1)
host = "127.0.0.1"

# Server port (default: 8080)
port = 8080

# Number of worker threads (0 = number of CPU cores)
workers = 0

# Enable HTTP/2 protocol support (default: true)
# When true, server uses automatic HTTP/1.1 and HTTP/2 cleartext (h2c) negotiation
# When false, server only supports HTTP/1.1
# HTTP/2 offers:
# - Multiplexed requests (multiple requests on single connection)
# - Header compression (HPACK)
# - Binary protocol (more efficient parsing)
# - Server push support (for future features)
enable_http2 = true

# API version (default: "v1")
# Controls the versioned endpoint prefix (e.g., /v1/api/sql)
api_version = "v1"

# Unique node identifier for this server instance (Phase 10, US0, FR-000)
# Used for:
# - Distributed coordination in multi-node deployments
# - Logging context (appears in all log entries)
# - Live query routing (WebSocket connection tracking)
# - Job execution tracking (which node executed which job)
#
# **IMPORTANT**: Each server instance MUST have a unique node_id in distributed setups
# Format: alphanumeric string with hyphens (e.g., "node-prod-01", "us-west-2-node-3")
# Default: "node1"
node_id = "node1"

[storage]
# RocksDB data directory path (relative or absolute)
rocksdb_path = "./data/rocksdb"

# Default storage path for 'local' storage (when base_directory='')
# Used for table flushes to Parquet files (default: "./data/storage")
# Default base path for flushed Parquet files (relative paths resolve from server CWD)
default_storage_path = "./data/storage"

# Templates for table storage paths (used by 'local' storage)
# Available placeholders: {namespace}, {tableName}, {userId}
# Final paths: {default_storage_path}/{template}
# Examples:
#   Shared table: ./data/storage/myapp/products
#   User table: ./data/storage/myapp/preferences/user123
shared_tables_template = "{namespace}/{tableName}"
user_tables_template = "{namespace}/{tableName}/{userId}"

# Enable Write-Ahead Log for durability (default: true)
enable_wal = true

# Compression algorithm: none, snappy, zlib, lz4, zstd (default: snappy)
compression = "snappy"

[storage.rocksdb]
# Write buffer size per column family in bytes (default: 64MB)
# Larger values improve write throughput but use more memory
# TUNED: Increased to 128MB for better batch write performance
write_buffer_size = 134217728

# Maximum number of write buffers (default: 3)
# Allows writes to continue while buffers are being flushed
# TUNED: Increased to 6 for better concurrent write handling
max_write_buffers = 6

# Block cache size for reads in bytes (default: 256MB)
# Larger values improve read performance for hot data
block_cache_size = 268435456

# Maximum number of background compaction/flush jobs (default: 4)
# TUNED: Increased to 8 to match typical CPU core count
max_background_jobs = 8

[datafusion]
# Memory limit for query execution in bytes (default: 1GB)
# Queries exceeding this limit will be terminated
memory_limit = 1073741824

# Number of parallel threads for query execution (default: number of CPU cores)
# Set to 0 to auto-detect CPU count
query_parallelism = 0

# Maximum number of partitions per query (default: 16)
# Higher values increase parallelism but use more resources
max_partitions = 16

# Batch size for record processing (default: 8192 rows)
# Larger batches improve throughput but use more memory
batch_size = 8192

[flush]
# Default row limit for flush policies (default: 10000 rows)
# Tables without explicit flush policy will use this value
default_row_limit = 10000

# Default time interval for flush in seconds (default: 300s = 5 minutes)
# Tables will flush to Parquet after this duration
default_time_interval = 300

# Batch size for flush operations (default: 10000 rows)
# Controls how many rows are loaded into memory at once during flush
# Lower values reduce memory usage but may increase flush duration
# Set to 0 to load all rows at once (not recommended for large tables)
flush_batch_size = 10000

# T158j: Flush job shutdown timeout in seconds (default: 300s = 5 minutes)
# Server waits this duration for active flush jobs to complete during shutdown
flush_job_shutdown_timeout_seconds = 300

# T158q: Job retention days (default: 30 days)
# Job records older than this are deleted during cleanup
job_retention_days = 30

# T158r: Job cleanup schedule (cron format, default: daily at midnight UTC)
# Format: "second minute hour day_of_month month day_of_week"
# Example: "0 0 * * *" = daily at midnight
job_cleanup_schedule = "0 0 * * *"

[retention]
# Default retention hours for soft-deleted rows (default: 168 hours = 7 days)
# Rows with _deleted=true will be kept in Parquet files for this duration
default_deleted_retention_hours = 168

[stream]
# Default TTL for stream table rows in seconds (default: 10 seconds)
# Stream tables are ephemeral - rows expire after this duration
default_ttl_seconds = 10

# Default maximum buffer size for stream tables (default: 10000 rows)
# Oldest rows are evicted when buffer exceeds this limit
default_max_buffer = 10000

# Stream eviction interval in seconds (default: 60 seconds = 1 minute)
# How often the background task checks and evicts expired events
eviction_interval_seconds = 60

[limits]
# Maximum message size for REST API requests in bytes (default: 1MB)
max_message_size = 1048576

# Maximum rows that can be returned in a single query (default: 1000)
max_query_limit = 1000

# Default LIMIT for queries without explicit LIMIT clause (default: 50)
default_query_limit = 50

[logging]
# Log level: error, warn, info, debug, trace (default: info)
level = "info"

# Directory for all log files (default: "./logs")
# Server will create app.log, slow.log, and other log files in this directory
logs_path = "./logs"

# Also log to console/stdout (default: true)
log_to_console = true

# Log format: compact, pretty, json (default: compact)
format = "compact"

# Slow query logging threshold in milliseconds (default: 1000ms = 1 second)
# Queries taking longer than this threshold will be logged to slow.log
# AND displayed as WARN in the console
# Set to a high value (e.g., 999999) to disable slow query logging
slow_query_threshold_ms = 1000

[performance]
# Request timeout in seconds (default: 30s)
# Requests exceeding this duration will be terminated
request_timeout = 30

# Keep-alive timeout in seconds (default: 75s)
keepalive_timeout = 75

# Maximum concurrent connections (default: 25000)
# Includes both REST API and WebSocket connections
max_connections = 25000

[rate_limit]
# Maximum SQL queries per second per user (default: 100)
# Prevents query flooding from a single user
# NOTE: Set higher for development/testing environments
max_queries_per_sec = 1000

# Maximum WebSocket messages per second per connection (default: 50)
# Prevents message flooding on WebSocket connections
max_messages_per_sec = 100

# Maximum concurrent live query subscriptions per user (default: 10)
# Limits total active subscriptions to prevent resource exhaustion
max_subscriptions_per_user = 50

# ============================================================================
# Security Settings
# ============================================================================
# CORS, WebSocket, and request limit configuration

[security]
# Maximum request body size in bytes (default: 10MB)
# Prevents memory exhaustion from large payloads
max_request_body_size = 10485760

# Maximum WebSocket message size in bytes (default: 1MB)
# Prevents memory exhaustion from large WebSocket messages
max_ws_message_size = 1048576

# Allowed WebSocket origins (if different from CORS origins)
# Leave empty to use CORS allowed_origins for WebSocket validation
allowed_ws_origins = []

# Strict WebSocket origin checking (default: false)
# If true, rejects WebSocket connections without Origin header
strict_ws_origin_check = false

# CORS Configuration (uses actix-cors)
# See: https://docs.rs/actix-cors
[security.cors]
# Allowed origins for CORS requests
# Use ["*"] or empty [] for any origin (development mode)
# For production, specify exact origins: ["https://app.example.com", "https://admin.example.com"]
allowed_origins = []

# Allowed HTTP methods (default: common REST methods)
allowed_methods = ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]

# Allowed HTTP headers
# Use ["*"] to allow any header
allowed_headers = ["Authorization", "Content-Type", "Accept", "Origin", "X-Requested-With"]

# Headers to expose to the browser (default: none)
# Example: ["X-Custom-Header", "X-Request-Id"]
expose_headers = []

# Allow credentials (cookies, authorization headers) (default: true)
# Note: If true, allowed_origins cannot be ["*"] in browsers
allow_credentials = true

# Preflight request cache max age in seconds (default: 3600 = 1 hour)
max_age = 3600

# Allow private network requests (default: false)
# Enables Access-Control-Request-Private-Network header support
allow_private_network = false

[authentication]
# Bcrypt cost factor for password hashing (default: 12, range: 10-14)
# Higher values = more secure but slower
# Changing this only affects NEW passwords
bcrypt_cost = 12

# Minimum password length (default: 8)
min_password_length = 8

# Maximum password length (default: 72, bcrypt limit)
# Note: Passwords longer than 72 bytes are truncated by bcrypt
max_password_length = 72

# Disable common password checking (default: false)
# If true, allows passwords like "password", "123456", etc.
# WARNING: Only disable for testing/development environments!
disable_common_password_check = false

# JWT configuration (for JWT Bearer token authentication)
# Secret key for JWT signature validation (minimum 32 characters recommended)
# IMPORTANT: Change this in production! Use a strong, random secret.
jwt_secret = "your-secret-key-at-least-32-chars-change-me-in-production"

# List of trusted JWT issuers (leave empty to accept any issuer)
# Add your OAuth provider domains here (e.g., "https://accounts.google.com", "https://github.com")
# Example for Google OAuth: ["https://accounts.google.com"]
# Example for GitHub OAuth: ["https://github.com"]
# Multiple issuers: ["https://accounts.google.com", "https://github.com", "https://kalamdb.io"]
jwt_trusted_issuers = ""

# Allow remote access for system users (default: false)
# If true, system users can authenticate remotely (requires password)
# If false, system users can only authenticate from localhost
allow_remote_access = false

[shutdown]
# Timeout settings for graceful shutdown

[shutdown.flush]
# Timeout in seconds to wait for flush jobs to complete during graceful shutdown (default: 300)
timeout = 300

# Maximum number of concurrent jobs (default: 10)
# Controls how many jobs can execute simultaneously
max_concurrent = 10

# Maximum number of retry attempts per job (default: 3)
# Jobs will be retried this many times before being marked as permanently failed
max_retries = 3

# Initial retry backoff delay in milliseconds (default: 100ms)
# Delay increases exponentially with each retry (100ms, 200ms, 400ms, etc.)
retry_backoff_ms = 100

# Phase 11, T026: SQL Handler Execution Configuration
[execution]
# Handler execution timeout in seconds (default: 30)
# Maximum time allowed for a single SQL statement to execute
# Prevents hung requests from blocking resources
handler_timeout_seconds = 30

# Maximum number of parameters per statement (default: 50)
# Prevents memory exhaustion from excessive parameter arrays
max_parameters = 50

# Maximum size per parameter in bytes (default: 524288 = 512KB)
# Prevents memory exhaustion from individual large parameters
max_parameter_size_bytes = 524288

