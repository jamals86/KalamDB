import { startTransition, useCallback, useEffect, useMemo, useRef, useState } from "react";
import { PanelRightClose, PanelRightOpen } from "lucide-react";
import { QueryTabStrip } from "@/components/sql-studio-v2/QueryTabStrip";
import { StudioEditorPanel } from "@/components/sql-studio-v2/StudioEditorPanel";
import { StudioExplorerPanel } from "@/components/sql-studio-v2/StudioExplorerPanel";
import { StudioInspectorPanel } from "@/components/sql-studio-v2/StudioInspectorPanel";
import { StudioResultsGrid } from "@/components/sql-studio-v2/StudioResultsGrid";
import { Button } from "@/components/ui/button";
import { ResizableHandle, ResizablePanel, ResizablePanelGroup } from "@/components/ui/resizable";
import { useAppDispatch, useAppSelector } from "@/store/hooks";
import { useAuth } from "@/lib/auth";
import { subscribe, type Unsubscribe } from "@/lib/kalam-client";
import type {
  QueryRunSummary,
  QueryTab,
  StudioTable,
} from "@/components/sql-studio-v2/types";
import {
  loadSqlStudioWorkspaceState,
  saveSqlStudioWorkspaceState,
} from "@/components/sql-studio-v2/workspaceState";
import {
  executeSqlStudioQuery,
  normalizeSchema,
  type RawQuerySchemaField,
} from "@/services/sqlStudioService";
import {
  addWorkspaceTab,
  appendWorkspaceLiveRows,
  appendWorkspaceResultLog,
  closeWorkspaceTab,
  hydrateSqlStudioWorkspace,
  prependWorkspaceHistory,
  setWorkspaceLiveSchema,
  setWorkspaceActiveTabId,
  setWorkspaceRunning,
  setWorkspaceSavedQueries,
  setWorkspaceTabResult,
  setWorkspaceTabs,
  updateWorkspaceTab,
} from "@/features/sql-studio/state/sqlStudioWorkspaceSlice";
import {
  hydrateSqlStudioUi,
  setHorizontalLayout,
  setInspectorCollapsed,
  setNamespaceExpanded,
  setSchemaFilter,
  setSelectedTableKey,
  setTableExpanded,
  setVerticalLayout,
  toggleFavoritesExpanded,
  toggleNamespaceExpanded,
  toggleTableExpanded,
} from "@/features/sql-studio/state/sqlStudioUiSlice";
import {
  selectExpandedNamespaces,
  selectExpandedTables,
  selectFavoritesExpanded,
  selectHorizontalLayout,
  selectIsInspectorCollapsed,
  selectSchemaFilter,
  selectSelectedTableKey,
  selectVerticalLayout,
  selectWorkspaceActiveTabId,
  selectWorkspaceHistory,
  selectWorkspaceIsRunning,
  selectWorkspaceSavedQueries,
  selectWorkspaceTabResults,
  selectWorkspaceTabs,
} from "@/features/sql-studio/state/selectors";
import { useGetSqlStudioSchemaTreeQuery } from "@/store/apiSlice";
import {
  buildSelectFromTableSql,
  createLogEntry,
  createQueryTab,
  createSavedQueryId,
  createTabId,
  resolveResultView,
  toPersistedTab,
} from "@/features/sql-studio/utils/workspaceHelpers";
import { ExplorerTableContextMenu } from "@/features/sql-studio/components/ExplorerTableContextMenu";

const FAVORITE_QUERIES = [
  "Top active users (24h)",
  "Jobs failed in last hour",
  "Namespace growth trend",
];

function normalizeLiveRows(rows: unknown[]): Record<string, unknown>[] {
  return rows.map((row) => {
    if (row instanceof Map) {
      return Object.fromEntries(row.entries()) as Record<string, unknown>;
    }
    if (typeof row === "object" && row !== null) {
      return row as Record<string, unknown>;
    }
    return { value: row };
  });
}

export default function SqlStudio() {
  const initialWorkspace = useMemo(() => {
    const fallbackTab = createQueryTab(1);
    return loadSqlStudioWorkspaceState(toPersistedTab(fallbackTab));
  }, []);

  const dispatch = useAppDispatch();
  const { user } = useAuth();
  const tabs = useAppSelector(selectWorkspaceTabs);
  const savedQueries = useAppSelector(selectWorkspaceSavedQueries);
  const activeTabId = useAppSelector(selectWorkspaceActiveTabId);
  const { data: schema = [] } = useGetSqlStudioSchemaTreeQuery();
  const schemaFilter = useAppSelector(selectSchemaFilter);
  const favoritesExpanded = useAppSelector(selectFavoritesExpanded);
  const expandedNamespaces = useAppSelector(selectExpandedNamespaces);
  const expandedTables = useAppSelector(selectExpandedTables);
  const selectedTableKey = useAppSelector(selectSelectedTableKey);
  const isRunning = useAppSelector(selectWorkspaceIsRunning);
  const tabResults = useAppSelector(selectWorkspaceTabResults);
  const history = useAppSelector(selectWorkspaceHistory);
  const isInspectorCollapsed = useAppSelector(selectIsInspectorCollapsed);
  const horizontalLayout = useAppSelector(selectHorizontalLayout);
  const verticalLayout = useAppSelector(selectVerticalLayout);
  const [explorerContextMenu, setExplorerContextMenu] = useState<{
    x: number;
    y: number;
    table: StudioTable;
  } | null>(null);
  const [isUiHydrated, setIsUiHydrated] = useState(false);
  const liveUnsubscribeRef = useRef<Record<string, Unsubscribe>>({});

  const activeTab = useMemo(
    () => {
      if (tabs.length === 0) {
        return null;
      }
      return tabs.find((item) => item.id === activeTabId) ?? tabs[0];
    },
    [tabs, activeTabId],
  );
  const activeResult = activeTab ? (tabResults[activeTab.id] ?? null) : null;
  const selectedTable = useMemo(() => {
    if (!selectedTableKey) {
      return null;
    }
    const [namespaceName, tableName] = selectedTableKey.split(".");
    const namespace = schema.find((item) => item.name === namespaceName);
    return namespace?.tables.find((item) => item.name === tableName) ?? null;
  }, [schema, selectedTableKey]);

  useEffect(() => {
    const workspaceTabs = initialWorkspace.tabs.map((tab) => ({
      id: tab.id,
      title: tab.name,
      sql: tab.query,
      isDirty: tab.settings.isDirty,
      isLive: tab.settings.isLive,
      liveStatus: tab.settings.liveStatus,
      resultView: tab.settings.resultView,
      lastSavedAt: tab.settings.lastSavedAt,
      savedQueryId: tab.settings.savedQueryId,
    }));
    const workspaceSavedQueries = initialWorkspace.savedQueries.map((item) => ({
      id: item.id,
      title: item.title,
      sql: item.sql,
      lastSavedAt: item.lastSavedAt,
      isLive: item.isLive,
    }));

    dispatch(hydrateSqlStudioWorkspace({
      tabs: workspaceTabs,
      savedQueries: workspaceSavedQueries,
      activeTabId: initialWorkspace.activeTabId,
    }));

    dispatch(hydrateSqlStudioUi({
      schemaFilter: initialWorkspace.explorerTree.filter,
      favoritesExpanded: initialWorkspace.explorerTree.favoritesExpanded,
      expandedNamespaces: initialWorkspace.explorerTree.expandedNamespaces,
      expandedTables: initialWorkspace.explorerTree.expandedTables,
      selectedTableKey: initialWorkspace.selectedTableKey,
      isInspectorCollapsed: initialWorkspace.inspectorCollapsed,
      horizontalLayout: initialWorkspace.sizes.explorerMain,
      verticalLayout: initialWorkspace.sizes.editorResults,
    }));
    setIsUiHydrated(true);
  }, [dispatch, initialWorkspace]);

  useEffect(() => {
    if (!selectedTableKey && schema.length > 0 && schema[0].tables.length > 0) {
      const firstTable = schema[0].tables[0];
      dispatch(setSelectedTableKey(`${firstTable.namespace}.${firstTable.name}`));
    }
  }, [dispatch, schema, selectedTableKey]);

  useEffect(() => {
    if (schema.length === 0 || Object.keys(expandedNamespaces).length > 0) {
      return;
    }

    const initialExpanded: Record<string, boolean> = {};
    schema.slice(0, 3).forEach((namespace) => {
      initialExpanded[namespace.name] = true;
    });
    dispatch(hydrateSqlStudioUi({ expandedNamespaces: initialExpanded }));
  }, [dispatch, schema, expandedNamespaces]);

  useEffect(() => {
    if (!selectedTableKey) {
      return;
    }

    const [namespaceName] = selectedTableKey.split(".");
    dispatch(setNamespaceExpanded({ namespaceName, expanded: true }));
    dispatch(setTableExpanded({ tableKey: selectedTableKey, expanded: true }));
  }, [dispatch, selectedTableKey]);

  const updateTab = useCallback((tabId: string, updates: Partial<QueryTab>) => {
    dispatch(updateWorkspaceTab({ tabId, updates }));
  }, [dispatch]);

  const updateActiveTab = useCallback((updates: Partial<QueryTab>) => {
    if (!activeTab) {
      return;
    }
    updateTab(activeTab.id, updates);
  }, [activeTab, updateTab]);

  const addTab = () => {
    const nextIndex = tabs.length + 1;
    const tab = createQueryTab(nextIndex);
    dispatch(addWorkspaceTab(tab));
    dispatch(setWorkspaceActiveTabId(tab.id));
  };

  const closeTab = useCallback((tabId: string) => {
    if (tabs.length === 1) {
      return;
    }

    const unsubscribe = liveUnsubscribeRef.current[tabId];
    if (unsubscribe) {
      unsubscribe();
      delete liveUnsubscribeRef.current[tabId];
    }

    dispatch(closeWorkspaceTab(tabId));
  }, [dispatch, tabs]);

  const openQueryInNewTab = (query: string, title: string) => {
    const tab: QueryTab = {
      id: createTabId(tabs.length + 1),
      title,
      sql: query,
      isDirty: true,
      isLive: false,
      liveStatus: "idle",
      resultView: "results",
      lastSavedAt: null,
      savedQueryId: null,
    };
    dispatch(addWorkspaceTab(tab));
    dispatch(setWorkspaceActiveTabId(tab.id));
  };

  const executeQueryForTab = async (tabId: string, sql: string, tabTitle: string) => {
    if (!sql.trim()) {
      return;
    }

    dispatch(setWorkspaceRunning(true));
    const startedAt = Date.now();

    try {
      const queryResult = await executeSqlStudioQuery(sql);
      const durationMs = Math.round(Date.now() - startedAt);
      const historyEntry: QueryRunSummary = {
        id: `${tabId}-${startedAt}`,
        tabTitle,
        sql,
        status: queryResult.status,
        executedAt: new Date().toISOString(),
        durationMs,
        rowCount: queryResult.rowCount,
        errorMessage: queryResult.errorMessage,
      };

      startTransition(() => {
        dispatch(setWorkspaceTabResult({ tabId, result: queryResult }));
        dispatch(prependWorkspaceHistory(historyEntry));
        updateTab(tabId, {
          isDirty: false,
          resultView: resolveResultView(queryResult),
        });
      });
    } catch (error) {
      const message = error instanceof Error ? error.message : "Query execution failed";
      dispatch(setWorkspaceTabResult({ tabId, result: {
        status: "error",
        rows: [],
        schema: [],
        tookMs: 0,
        rowCount: 0,
        logs: [createLogEntry(message, "error", user?.username, error)],
        errorMessage: message,
      } }));
      updateTab(tabId, { resultView: "log" });
    } finally {
      dispatch(setWorkspaceRunning(false));
    }
  };

  const stopLiveQuery = useCallback((tabId: string) => {
    const unsubscribe = liveUnsubscribeRef.current[tabId];
    if (unsubscribe) {
      unsubscribe();
      delete liveUnsubscribeRef.current[tabId];
    }
    updateTab(tabId, { liveStatus: "idle" });
  }, [updateTab]);

  const startLiveQuery = useCallback(async (tab: QueryTab) => {
    if (!tab.sql.trim()) {
      return;
    }

    dispatch(setWorkspaceTabResult({
      tabId: tab.id,
      result: {
        status: "success",
        rows: [],
        schema: [],
        tookMs: 0,
        rowCount: 0,
        logs: [createLogEntry("Starting live subscription.", "info", user?.username, {
          event: "live_start",
          sql: tab.sql,
        })],
      },
    }));
    updateTab(tab.id, { liveStatus: "connecting", isLive: true });
    try {
      const unsubscribe = await subscribe(tab.sql, (event) => {
        const serverMessage = event as {
          type?: string;
          rows?: Record<string, unknown>[];
          change_type?: string;
          message?: string;
          code?: string;
          schema?: RawQuerySchemaField[];
        };

        if (serverMessage.type === "error") {
          dispatch(appendWorkspaceResultLog({
            tabId: tab.id,
            entry: createLogEntry(serverMessage.message ?? "Live query error", "error", user?.username, serverMessage),
            statusOverride: "error",
          }));
          updateTab(tab.id, { liveStatus: "error" });
          return;
        }

        if (serverMessage.type === "subscription_ack") {
          if (Array.isArray(serverMessage.schema) && serverMessage.schema.length > 0) {
            dispatch(setWorkspaceLiveSchema({
              tabId: tab.id,
              schema: normalizeSchema(serverMessage.schema),
            }));
          }
          dispatch(appendWorkspaceResultLog({
            tabId: tab.id,
            entry: createLogEntry("Live subscription connected.", "info", user?.username, serverMessage),
          }));
          updateTab(tab.id, { liveStatus: "connected", resultView: "results" });
          return;
        }

        if (Array.isArray(serverMessage.rows)) {
          const receivedRows = normalizeLiveRows(serverMessage.rows);
          const changeType = serverMessage.type === "change"
            ? (serverMessage.change_type ?? "change")
            : "initial";

          dispatch(appendWorkspaceLiveRows({
            tabId: tab.id,
            rows: receivedRows,
            changeType,
            schema: normalizeSchema(serverMessage.schema),
          }));
          dispatch(appendWorkspaceResultLog({
            tabId: tab.id,
            entry: createLogEntry(
              `Received ${receivedRows.length} row${receivedRows.length === 1 ? "" : "s"} (${changeType}).`,
              "info",
              user?.username,
              serverMessage,
            ),
          }));
          updateTab(tab.id, { liveStatus: "connected", resultView: "results" });
          return;
        }

        if (Array.isArray(event)) {
          const receivedRows = normalizeLiveRows(event as unknown[]);
          dispatch(appendWorkspaceLiveRows({
            tabId: tab.id,
            rows: receivedRows,
            changeType: "data",
          }));
          dispatch(appendWorkspaceResultLog({
            tabId: tab.id,
            entry: createLogEntry(
              `Received ${receivedRows.length} row${receivedRows.length === 1 ? "" : "s"} (data).`,
              "info",
              user?.username,
              event,
            ),
          }));
          updateTab(tab.id, { liveStatus: "connected", resultView: "results" });
        }
      });

      liveUnsubscribeRef.current[tab.id] = unsubscribe;
    } catch (error) {
      console.error("Failed to subscribe to live query", error);
      dispatch(appendWorkspaceResultLog({
        tabId: tab.id,
        entry: createLogEntry(
          error instanceof Error ? error.message : "Failed to subscribe to live query",
          "error",
          user?.username,
          error,
        ),
        statusOverride: "error",
      }));
      updateTab(tab.id, { liveStatus: "error" });
    }
  }, [dispatch, updateTab, user?.username]);

  const runActiveQuery = async () => {
    if (!activeTab) {
      return;
    }

    if (activeTab.isLive) {
      if (activeTab.liveStatus === "connected") {
        stopLiveQuery(activeTab.id);
      } else {
        await startLiveQuery(activeTab);
      }
      return;
    }

    await executeQueryForTab(activeTab.id, activeTab.sql, activeTab.title);
  };

  const saveTab = useCallback((tabId: string, openAsCopy: boolean) => {
    const tab = tabs.find((item) => item.id === tabId);
    if (!tab) {
      return;
    }

    const nowIso = new Date().toISOString();
    const saveId = openAsCopy || !tab.savedQueryId ? createSavedQueryId() : tab.savedQueryId;
    const saveTitle = openAsCopy ? `${tab.title} Copy` : tab.title;

    const nextSavedQueries = (() => {
      const previous = savedQueries;
      const existing = previous.find((item) => item.id === saveId);
      if (existing) {
        return previous.map((item) =>
          item.id === saveId
            ? { ...item, title: saveTitle, sql: tab.sql, isLive: tab.isLive, lastSavedAt: nowIso }
            : item,
        );
      }
      return [
        {
          id: saveId,
          title: saveTitle,
          sql: tab.sql,
          isLive: tab.isLive,
          lastSavedAt: nowIso,
        },
        ...previous,
      ];
    })();
    dispatch(setWorkspaceSavedQueries(nextSavedQueries));

    if (openAsCopy) {
      const copiedTab: QueryTab = {
        ...tab,
        id: createTabId(tabs.length + 1),
        title: saveTitle,
        isDirty: false,
        savedQueryId: saveId,
        lastSavedAt: nowIso,
        liveStatus: "idle",
        resultView: tab.resultView,
      };
      dispatch(addWorkspaceTab(copiedTab));
      dispatch(setWorkspaceActiveTabId(copiedTab.id));
      if (tabResults[tab.id]) {
        dispatch(setWorkspaceTabResult({ tabId: copiedTab.id, result: tabResults[tab.id] ?? null }));
      }
      return;
    }

    updateTab(tab.id, {
      savedQueryId: saveId,
      lastSavedAt: nowIso,
      isDirty: false,
    });
  }, [dispatch, savedQueries, tabs, tabResults, updateTab]);

  const renameActiveTab = useCallback((title: string) => {
    if (!activeTab) {
      return;
    }

    updateTab(activeTab.id, { title });
    if (activeTab.savedQueryId) {
      dispatch(setWorkspaceSavedQueries(
        savedQueries.map((item) =>
          item.id === activeTab.savedQueryId ? { ...item, title } : item,
        ),
      ));
    }
  }, [activeTab, dispatch, savedQueries, updateTab]);

  const deleteActiveTab = useCallback(() => {
    if (!activeTab) {
      return;
    }

    const deletedSavedQueryId = activeTab.savedQueryId;
    closeTab(activeTab.id);
    if (deletedSavedQueryId) {
      dispatch(setWorkspaceSavedQueries(
        savedQueries.filter((item) => item.id !== deletedSavedQueryId),
      ));
      dispatch(setWorkspaceTabs(
        tabs.map((item) =>
          item.savedQueryId === deletedSavedQueryId
            ? { ...item, savedQueryId: null }
            : item,
        ),
      ));
    }
  }, [activeTab, closeTab, dispatch, savedQueries, tabs]);

  const openSavedQuery = useCallback((queryId: string) => {
    const savedQuery = savedQueries.find((item) => item.id === queryId);
    if (!savedQuery) {
      return;
    }

    const existingTab = tabs.find((item) => item.savedQueryId === queryId);
    if (existingTab) {
      dispatch(setWorkspaceActiveTabId(existingTab.id));
      return;
    }

    const tab: QueryTab = {
      id: createTabId(tabs.length + 1),
      title: savedQuery.title,
      sql: savedQuery.sql,
      isDirty: false,
      isLive: savedQuery.isLive,
      liveStatus: "idle",
      resultView: "results",
      lastSavedAt: savedQuery.lastSavedAt,
      savedQueryId: savedQuery.id,
    };
    dispatch(addWorkspaceTab(tab));
    dispatch(setWorkspaceActiveTabId(tab.id));
  }, [dispatch, savedQueries, tabs]);

  const toggleInspector = () => {
    if (isInspectorCollapsed) {
      dispatch(setInspectorCollapsed(false));
      return;
    }
    dispatch(setInspectorCollapsed(true));
  };

  useEffect(() => {
    if (!explorerContextMenu) {
      return;
    }

    const handleEscape = (event: KeyboardEvent) => {
      if (event.key === "Escape") {
        setExplorerContextMenu(null);
      }
    };
    window.addEventListener("keydown", handleEscape);
    return () => window.removeEventListener("keydown", handleEscape);
  }, [explorerContextMenu]);

  useEffect(() => {
    return () => {
      Object.values(liveUnsubscribeRef.current).forEach((unsubscribe) => unsubscribe());
      liveUnsubscribeRef.current = {};
    };
  }, []);

  useEffect(() => {
    if (tabs.length === 0 || !isUiHydrated) {
      return;
    }

    const persistedActiveTabId = tabs.find((tab) => tab.id === activeTabId)?.id ?? tabs[0].id;

    saveSqlStudioWorkspaceState({
      version: 1,
      tabs: tabs.map(toPersistedTab),
      savedQueries: savedQueries.map((item) => ({
        id: item.id,
        title: item.title,
        sql: item.sql,
        lastSavedAt: item.lastSavedAt,
        isLive: item.isLive,
      })),
      activeTabId: persistedActiveTabId,
      selectedTableKey,
      inspectorCollapsed: isInspectorCollapsed,
      sizes: {
        explorerMain: horizontalLayout,
        editorResults: verticalLayout,
      },
      explorerTree: {
        favoritesExpanded,
        expandedNamespaces,
        expandedTables,
        filter: schemaFilter,
      },
    });
  }, [
    tabs,
    activeTabId,
    selectedTableKey,
    isInspectorCollapsed,
    horizontalLayout,
    verticalLayout,
    favoritesExpanded,
    savedQueries,
    expandedNamespaces,
    expandedTables,
    schemaFilter,
    isUiHydrated,
  ]);

  if (!activeTab) {
    return (
      <div className="flex h-full items-center justify-center bg-[#101922] text-sm text-slate-400">
        Loading SQL workspace...
      </div>
    );
  }

  return (
    <div className="flex h-full min-h-0 flex-col overflow-hidden bg-[#101922] text-slate-200">
      <div className="flex min-h-0 flex-1 overflow-hidden">
        <ResizablePanelGroup orientation="horizontal" className="min-h-0 flex-1">
          <ResizablePanel
            defaultSize={horizontalLayout[0]}
            minSize="12%"
            maxSize="36%"
            className="min-h-0"
            onResize={(size) => {
              const numericSize = Number(size);
              if (!Number.isFinite(numericSize)) {
                return;
              }
              const safeSize = Math.max(12, Math.min(36, numericSize));
              dispatch(setHorizontalLayout([safeSize, 100 - safeSize]));
            }}
          >
            <StudioExplorerPanel
              schema={schema}
              filter={schemaFilter}
              favoriteQueries={FAVORITE_QUERIES}
              savedQueries={savedQueries}
              favoritesExpanded={favoritesExpanded}
              expandedNamespaces={expandedNamespaces}
              expandedTables={expandedTables}
              selectedTableKey={selectedTableKey}
              onFilterChange={(value) => dispatch(setSchemaFilter(value))}
              onToggleFavorites={() => dispatch(toggleFavoritesExpanded())}
              onToggleNamespace={(namespaceName) => dispatch(toggleNamespaceExpanded(namespaceName))}
              onToggleTable={(tableKey) => dispatch(toggleTableExpanded(tableKey))}
              onOpenSavedQuery={openSavedQuery}
              onSelectTable={(table) => dispatch(setSelectedTableKey(`${table.namespace}.${table.name}`))}
              onTableContextMenu={(table, position) => {
                setExplorerContextMenu({
                  x: position.x,
                  y: position.y,
                  table,
                });
              }}
            />
          </ResizablePanel>

          <ResizableHandle withHandle />

          <ResizablePanel defaultSize={horizontalLayout[1]} minSize="40%" className="min-h-0">
            <div className="relative flex h-full min-h-0 flex-col overflow-hidden bg-white dark:bg-[#101922]">
              <div className="absolute right-2 top-1.5 z-20">
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-8 w-8 text-slate-500 hover:text-slate-200"
                  onClick={toggleInspector}
                  title={isInspectorCollapsed ? "Expand details panel" : "Collapse details panel"}
                >
                  {isInspectorCollapsed ? (
                    <PanelRightOpen className="h-4 w-4" />
                  ) : (
                    <PanelRightClose className="h-4 w-4" />
                  )}
                </Button>
              </div>

              <QueryTabStrip
                tabs={tabs}
                activeTabId={activeTab.id}
                onTabSelect={(tabId) => dispatch(setWorkspaceActiveTabId(tabId))}
                onAddTab={addTab}
                onCloseTab={closeTab}
              />

              <ResizablePanelGroup orientation="vertical" className="min-h-0 flex-1">
                <ResizablePanel
                  defaultSize={verticalLayout[0]}
                  minSize="20%"
                  className="min-h-0"
                  onResize={(size) => {
                    const numericSize = Number(size);
                    if (!Number.isFinite(numericSize)) {
                      return;
                    }
                    const safeSize = Math.max(20, Math.min(80, numericSize));
                    dispatch(setVerticalLayout([safeSize, 100 - safeSize]));
                  }}
                >
                  <StudioEditorPanel
                    schema={schema}
                    tabTitle={activeTab.title}
                    lastSavedAt={activeTab.lastSavedAt}
                    isLive={activeTab.isLive}
                    liveStatus={activeTab.liveStatus}
                    sql={activeTab.sql}
                    isRunning={isRunning}
                    onSqlChange={(value) => updateActiveTab({ sql: value, isDirty: true })}
                    onRun={runActiveQuery}
                    onToggleLive={(checked) => {
                      updateActiveTab({ isLive: checked, liveStatus: "idle" });
                      if (!checked && activeTab.liveStatus === "connected") {
                        stopLiveQuery(activeTab.id);
                      }
                    }}
                    onRename={renameActiveTab}
                    onSave={() => saveTab(activeTab.id, false)}
                    onSaveCopy={() => saveTab(activeTab.id, true)}
                    onDelete={deleteActiveTab}
                  />
                </ResizablePanel>

                <ResizableHandle withHandle />

                <ResizablePanel defaultSize={verticalLayout[1]} minSize="20%" className="min-h-0">
                  <StudioResultsGrid
                    result={activeResult}
                    isRunning={isRunning}
                    isLiveMode={activeTab.isLive}
                    activeSql={activeTab.sql}
                    selectedTable={selectedTable}
                    currentUsername={user?.username ?? "admin"}
                    resultView={activeTab.resultView}
                    onResultViewChange={(view) => updateActiveTab({ resultView: view })}
                    onRefreshAfterCommit={() => executeQueryForTab(activeTab.id, activeTab.sql, activeTab.title)}
                  />
                </ResizablePanel>
              </ResizablePanelGroup>
            </div>
          </ResizablePanel>
        </ResizablePanelGroup>

        {!isInspectorCollapsed && (
          <div className="min-h-0 w-[320px] min-w-[240px] max-w-[420px] border-l border-[#1b2a40]">
            <StudioInspectorPanel selectedTable={selectedTable} history={history} />
          </div>
        )}
      </div>

      <ExplorerTableContextMenu
        contextMenu={explorerContextMenu}
        onClose={() => setExplorerContextMenu(null)}
        onOpenQueryInNewTab={(table) => {
          const sql = buildSelectFromTableSql(table.namespace, table.name, true);
          openQueryInNewTab(sql, table.name);
          dispatch(setSelectedTableKey(`${table.namespace}.${table.name}`));
          setExplorerContextMenu(null);
        }}
        onSelectFromTable={(table) => {
          const sql = buildSelectFromTableSql(table.namespace, table.name, true);
          updateActiveTab({ sql, isDirty: true });
          dispatch(setSelectedTableKey(`${table.namespace}.${table.name}`));
          setExplorerContextMenu(null);
          executeQueryForTab(activeTab.id, sql, activeTab.title).catch(console.error);
        }}
        onInsertSelectQuery={(table) => {
          const sql = buildSelectFromTableSql(table.namespace, table.name, false);
          updateActiveTab({ sql, isDirty: true });
          dispatch(setSelectedTableKey(`${table.namespace}.${table.name}`));
          setExplorerContextMenu(null);
        }}
        onViewProperties={(table) => {
          dispatch(setSelectedTableKey(`${table.namespace}.${table.name}`));
          dispatch(setInspectorCollapsed(false));
          setExplorerContextMenu(null);
        }}
        onCopyQualifiedName={(table) => {
          navigator.clipboard
            .writeText(`${table.namespace}.${table.name}`)
            .catch(console.error);
          setExplorerContextMenu(null);
        }}
      />
    </div>
  );
}
