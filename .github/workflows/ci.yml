name: CI

permissions:
  contents: write

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: "1.92.0"

jobs:
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    if: false  # Only run on manual trigger
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt

      - name: Run rustfmt
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy Check
    runs-on: ubuntu-latest
    if: false  # Only run on manual trigger
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang \
            libclang-dev \
            pkg-config \
            libssl-dev

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-target-

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # test:
  #   name: Test Suite
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Install Rust toolchain
  #       uses: dtolnay/rust-toolchain@stable
  #       with:
  #         toolchain: ${{ env.RUST_VERSION }}

  #     - name: Install system dependencies
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y --no-install-recommends \
  #           clang \
  #           libclang-dev \
  #           pkg-config \
  #           libssl-dev

  #     - name: Cache cargo registry
  #       uses: actions/cache@v4
  #       with:
  #         path: ~/.cargo/registry
  #         key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-cargo-registry-

  #     - name: Cache cargo index
  #       uses: actions/cache@v4
  #       with:
  #         path: ~/.cargo/git
  #         key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-cargo-index-

  #     - name: Cache cargo build
  #       uses: actions/cache@v4
  #       with:
  #         path: target
  #         key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-cargo-build-target-

  #     - name: Run tests
  #       run: cargo test --workspace --all-features

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang \
            libclang-dev \
            pkg-config \
            libssl-dev

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-target-

      - name: Install cargo-nextest
        run: |
          curl -LsSf https://get.nexte.st/latest/linux | tar zxf - -C ${CARGO_HOME:-~/.cargo}/bin

      - name: Run tests and generate badge
        run: |
          # Run tests with JSON output
          NEXTEST_EXPERIMENTAL_LIBTEST_JSON=1 cargo nextest run \
            --workspace \
            --no-fail-fast \
            --message-format libtest-json-plus > results.json 2>&1 || true
          
          # Parse JSON results to count tests
          # Each suite event has "passed" and "failed" counts
          # Example: {"type":"suite","event":"failed","passed":12,"failed":135,...}
          PASSED=$(grep -o '"type":"suite".*"passed":[0-9]*' results.json | grep -o '"passed":[0-9]*' | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
          FAILED=$(grep -o '"type":"suite".*"failed":[0-9]*' results.json | grep -o '"failed":[0-9]*' | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
          
          # Default to 0 if extraction failed
          PASSED=${PASSED:-0}
          FAILED=${FAILED:-0}
          TOTAL=$((PASSED + FAILED))
          
          echo "Tests: $PASSED passed, $FAILED failed (total: $TOTAL)"
          
          # Skip badge generation if parsing failed (total is 0)
          if [ "$TOTAL" -eq "0" ]; then
            echo "Error: No tests found. Parsing likely failed."
            echo "First 50 lines of results.json:"
            head -50 results.json
            exit 1
          fi
          
          # Determine badge color
          if [ "$FAILED" -eq "0" ]; then
            COLOR="brightgreen"
            MESSAGE="$PASSED/$TOTAL passed"
          else
            COLOR="red"
            MESSAGE="$PASSED/$TOTAL passed, $FAILED failed"
          fi
          
          echo "Badge: $MESSAGE ($COLOR)"
          
          # Generate badge JSON
          mkdir -p .github/badges
          cat > .github/badges/tests.json << EOF
          {
            "schemaVersion": 1,
            "label": "tests",
            "message": "$MESSAGE",
            "color": "$COLOR"
          }
          EOF
          
          cat .github/badges/tests.json

      - name: Commit badge
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/badges/tests.json
          git diff --staged --quiet || git commit -m "Update test badge [skip ci]"
          git push || echo "Nothing to push"
