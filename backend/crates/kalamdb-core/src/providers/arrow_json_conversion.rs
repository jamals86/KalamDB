use crate::error::KalamDbError;
use datafusion::arrow::record_batch::RecordBatch;
use datafusion::scalar::ScalarValue;
use kalamdb_commons::conversions::arrow_json_conversion as commons;
use kalamdb_commons::errors::CommonError;
use kalamdb_commons::models::rows::Row;
use serde_json::Value as JsonValue;
use std::collections::HashMap;

fn map_error(err: CommonError) -> KalamDbError {
    KalamDbError::InvalidOperation(err.to_string())
}

pub fn scalar_value_to_json(value: &ScalarValue) -> Result<JsonValue, KalamDbError> {
    commons::scalar_value_to_json(value).map_err(map_error)
}

pub fn record_batch_to_json_rows(
    batch: &RecordBatch,
) -> Result<Vec<HashMap<String, JsonValue>>, KalamDbError> {
    commons::record_batch_to_json_rows(batch).map_err(map_error)
}

pub fn record_batch_to_json_arrays(
    batch: &RecordBatch,
) -> Result<Vec<Vec<JsonValue>>, KalamDbError> {
    commons::record_batch_to_json_arrays(batch).map_err(map_error)
}

pub fn row_to_json_map(row: &Row) -> Result<HashMap<String, JsonValue>, KalamDbError> {
    commons::row_to_json_map(row).map_err(map_error)
}

pub use commons::{
    arrow_value_to_scalar, coerce_rows, coerce_updates, json_rows_to_arrow_batch, json_to_row,
    json_value_to_scalar, json_value_to_scalar_strict,
};
