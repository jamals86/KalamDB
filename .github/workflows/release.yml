name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version_tag:
        description: "Version tag for release (e.g. v0.1.2)"
        required: true
        default: "v0.1.2"

      platforms:
        description: "Comma-separated platforms (like --platforms). Ignored if all_platforms=true"
        required: false
        default: "linux-x86_64,macos-aarch64,windows-x86_64"

      all_platforms:
        description: "Build all platforms (like --all-platforms)"
        type: boolean
        required: false
        default: false

      github_release:
        description: "Publish GitHub Release"
        type: boolean
        required: false
        default: true

      docker_push:
        description: "Push Docker image to Docker Hub"
        type: boolean
        required: false
        default: true

      docker_repo:
        description: "Docker Hub repo (owner/name)"
        required: false
        default: "jamals86/kalamdb"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: "1.92.0"
  DEFAULT_PLATFORMS: "linux-x86_64,macos-aarch64,windows-x86_64"

jobs:
  build_ui:
    name: Build Admin UI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: wasm-build
          cache-on-failure: true

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install wasm-pack
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL --retry 5 --retry-delay 2 --retry-connrefused \
            https://rustwasm.github.io/wasm-pack/installer/init.sh | sh
          wasm-pack --version

      - name: Build SDK (kalam-link)
        shell: bash
        run: |
          set -euo pipefail
          cd link/sdks/typescript
          npm install
          npm run build

      - name: Build Admin UI
        shell: bash
        run: |
          set -euo pipefail
          cd ui
          npm install
          npm run build

      - name: Upload UI dist
        uses: actions/upload-artifact@v4
        with:
          name: ui-dist
          path: ui/dist/
          if-no-files-found: error

  build_cli_linux_x86_64:
    name: Build CLI Linux x86_64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${{ github.event.inputs.version_tag }}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-unknown-linux-gnu

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: cli-linux-x86_64
          cache-on-failure: true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang \
            libclang-dev \
            pkg-config \
            libssl-dev

      - name: Build CLI linux-x86_64
        shell: bash
        run: |
          set -euo pipefail
          cargo build \
            --profile release-dist \
            --target x86_64-unknown-linux-gnu \
            --bin kalam

      - name: Package CLI artifact
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION
          CLI_OUT="kalamcli-${VERSION}-linux-x86_64"
          cp "target/x86_64-unknown-linux-gnu/release-dist/kalam" "dist/$VERSION/$CLI_OUT"
          chmod +x "dist/$VERSION/$CLI_OUT"
          (cd "dist/$VERSION" && tar -czf "$CLI_OUT.tar.gz" "$CLI_OUT")

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-cli-linux-x86_64
          path: dist/${{ steps.vars.outputs.version }}/*.tar.gz
          if-no-files-found: error

  build_cli_windows_x86_64:
    name: Build CLI Windows x86_64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${{ github.event.inputs.version_tag }}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-pc-windows-gnu

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: cli-windows-x86_64
          cache-on-failure: true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends zip

      - name: Install cross
        shell: bash
        run: |
          set -euo pipefail
          cargo install cross --locked

      - name: Build CLI windows-x86_64
        shell: bash
        env:
          CROSS_CONTAINER_ENGINE_NO_BUILDKIT: "0"
        run: |
          set -euo pipefail
          cross build \
            --profile docker \
            --target x86_64-pc-windows-gnu \
            --bin kalam

      - name: Package CLI artifact
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION
          CLI_OUT="kalamcli-${VERSION}-windows-x86_64.exe"
          cp "target/x86_64-pc-windows-gnu/docker/kalam.exe" "dist/$VERSION/$CLI_OUT"
          (cd "dist/$VERSION" && zip -q "${CLI_OUT%.exe}.zip" "$CLI_OUT")

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-cli-windows-x86_64
          path: dist/${{ steps.vars.outputs.version }}/*.zip
          if-no-files-found: error

  build_cli_macos_arm:
    name: Build CLI macOS ARM
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${{ github.event.inputs.version_tag }}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-apple-darwin

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: cli-macos-aarch64
          cache-on-failure: true

      - name: Install LLVM (fix libclang.dylib)
        shell: bash
        run: |
          set -euo pipefail
          brew install llvm@16
          echo "LIBCLANG_PATH=$(brew --prefix llvm@16)/lib" >> "$GITHUB_ENV"
          echo "LLVM_CONFIG_PATH=$(brew --prefix llvm@16)/bin/llvm-config" >> "$GITHUB_ENV"

      - name: Build CLI macos-aarch64
        shell: bash
        run: |
          set -euo pipefail
          cargo build \
            --profile release-dist \
            --target aarch64-apple-darwin \
            --bin kalam

      - name: Package CLI artifact
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION
          CLI_OUT="kalamcli-${VERSION}-macos-aarch64"
          cp "target/aarch64-apple-darwin/release-dist/kalam" "dist/$VERSION/$CLI_OUT"
          chmod +x "dist/$VERSION/$CLI_OUT"
          (cd "dist/$VERSION" && tar -czf "$CLI_OUT.tar.gz" "$CLI_OUT")

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-cli-macos-arm
          path: dist/${{ steps.vars.outputs.version }}/*.tar.gz
          if-no-files-found: error

  build_linux_x86_64:
    name: Build Server Linux x86_64
    runs-on: ubuntu-latest
    needs: build_ui
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}
      PLATFORMS_INPUT: ${{ github.event.inputs.platforms }}
      ALL_PLATFORMS_INPUT: ${{ github.event.inputs.all_platforms }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"

          # Determine requested platforms for this run
          PLATFORMS_INPUT="${PLATFORMS_INPUT:-}"
          if [[ -z "${PLATFORMS_INPUT}" ]]; then
            PLATFORMS_INPUT="${{ env.DEFAULT_PLATFORMS }}"
          fi
          if [[ "${{ github.event_name }}" == "push" ]]; then
            PLATFORMS_INPUT="${{ env.DEFAULT_PLATFORMS }}"
          fi
          if [[ "${ALL_PLATFORMS_INPUT:-}" == "true" ]]; then
            PLATFORMS_INPUT="linux-x86_64,linux-aarch64,macos-x86_64,macos-aarch64,windows-x86_64"
          fi

          BUILD_LINUX=false
          if [[ "$PLATFORMS_INPUT" == *"linux-x86_64"* ]]; then BUILD_LINUX=true; fi

          {
            echo "platforms=$PLATFORMS_INPUT"
            echo "build_linux=$BUILD_LINUX"
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Download UI dist
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

      - name: Setup Rust
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-unknown-linux-gnu

      - name: Cache Rust
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: server-linux-x86_64
          cache-on-failure: true

      - name: Install system deps
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang \
            libclang-dev \
            pkg-config \
            libssl-dev

      - name: Build linux-x86_64 (release-dist)
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        shell: bash
        env:
          SKIP_UI_BUILD: "1"
        run: |
          set -euo pipefail
          cargo build \
            --profile release-dist \
            --target x86_64-unknown-linux-gnu \
            --bin kalamdb-server

      - name: Package linux artifacts
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION

          SRV_OUT="kalamdb-server-${VERSION}-linux-x86_64"

          cp "target/x86_64-unknown-linux-gnu/release-dist/kalamdb-server" "dist/$VERSION/$SRV_OUT"
          chmod +x "dist/$VERSION/$SRV_OUT"

          (cd "dist/$VERSION" && tar -czf "$SRV_OUT.tar.gz" "$SRV_OUT")

      - name: Upload artifacts
        if: ${{ steps.vars.outputs.build_linux == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-x86_64
          path: dist/${{ steps.vars.outputs.version }}/*
          if-no-files-found: error

  build_linux_aarch64:
    name: Build Server Linux ARM64
    runs-on: ubuntu-latest
    needs: build_ui
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}
      PLATFORMS_INPUT: ${{ github.event.inputs.platforms }}
      ALL_PLATFORMS_INPUT: ${{ github.event.inputs.all_platforms }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"

          # Always build linux-aarch64 for Docker multi-arch support
          BUILD_LINUX_ARM=true

          {
            echo "build_linux_arm=$BUILD_LINUX_ARM"
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Download UI dist
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

      - name: Setup Rust
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-unknown-linux-gnu

      - name: Cache Rust
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: server-linux-aarch64
          cache-on-failure: true

      - name: Install cross
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          cargo install cross --locked

      - name: Build linux-aarch64 (cross, docker profile)
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        shell: bash
        env:
          CROSS_CONTAINER_ENGINE_NO_BUILDKIT: "0"
          SKIP_UI_BUILD: "1"
        run: |
          set -euo pipefail
          cross build \
            --profile docker \
            --target aarch64-unknown-linux-gnu \
            --bin kalamdb-server

      - name: Package linux-aarch64 artifacts
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION

          SRV_OUT="kalamdb-server-${VERSION}-linux-aarch64"

          cp "target/aarch64-unknown-linux-gnu/docker/kalamdb-server" "dist/$VERSION/$SRV_OUT"
          chmod +x "dist/$VERSION/$SRV_OUT"

          (cd "dist/$VERSION" && tar -czf "$SRV_OUT.tar.gz" "$SRV_OUT")

      - name: Upload artifacts
        if: ${{ steps.vars.outputs.build_linux_arm == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-aarch64
          path: dist/${{ steps.vars.outputs.version }}/*
          if-no-files-found: error

  build_cli_linux_aarch64:
    name: Build CLI Linux ARM64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${{ github.event.inputs.version_tag }}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-unknown-linux-gnu

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: cli-linux-aarch64
          cache-on-failure: true

      - name: Install cross
        shell: bash
        run: |
          set -euo pipefail
          cargo install cross --locked

      - name: Build CLI linux-aarch64
        shell: bash
        env:
          CROSS_CONTAINER_ENGINE_NO_BUILDKIT: "0"
        run: |
          set -euo pipefail
          cross build \
            --profile docker \
            --target aarch64-unknown-linux-gnu \
            --bin kalam

      - name: Package CLI artifact
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION
          CLI_OUT="kalamcli-${VERSION}-linux-aarch64"
          cp "target/aarch64-unknown-linux-gnu/docker/kalam" "dist/$VERSION/$CLI_OUT"
          chmod +x "dist/$VERSION/$CLI_OUT"
          (cd "dist/$VERSION" && tar -czf "$CLI_OUT.tar.gz" "$CLI_OUT")

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-cli-linux-aarch64
          path: dist/${{ steps.vars.outputs.version }}/*.tar.gz
          if-no-files-found: error

  build_windows_x86_64:
    name: Build Windows x86_64
    runs-on: ubuntu-latest
    needs: build_ui
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}
      PLATFORMS_INPUT: ${{ github.event.inputs.platforms }}
      ALL_PLATFORMS_INPUT: ${{ github.event.inputs.all_platforms }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"

          PLATFORMS_INPUT="${PLATFORMS_INPUT:-}"
          if [[ -z "${PLATFORMS_INPUT}" ]]; then
            PLATFORMS_INPUT="${{ env.DEFAULT_PLATFORMS }}"
          fi
          if [[ "${{ github.event_name }}" == "push" ]]; then
            PLATFORMS_INPUT="${{ env.DEFAULT_PLATFORMS }}"
          fi
          if [[ "${ALL_PLATFORMS_INPUT:-}" == "true" ]]; then
            PLATFORMS_INPUT="linux-x86_64,linux-aarch64,macos-x86_64,macos-aarch64,windows-x86_64"
          fi

          BUILD_WINDOWS=false
          if [[ "$PLATFORMS_INPUT" == *"windows-x86_64"* ]]; then BUILD_WINDOWS=true; fi

          {
            echo "platforms=$PLATFORMS_INPUT"
            echo "build_windows=$BUILD_WINDOWS"
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Download UI dist
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

      - name: Setup Rust
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-pc-windows-gnu

      - name: Cache Rust
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: server-windows-x86_64
          cache-on-failure: true

      - name: Install system deps
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends zip

      - name: Install cross
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          cargo install cross --locked

      - name: Build windows-x86_64 (cross, docker profile)
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        shell: bash
        env:
          CROSS_CONTAINER_ENGINE_NO_BUILDKIT: "0"
          SKIP_UI_BUILD: "1"
        run: |
          set -euo pipefail
          cross build \
            --profile docker \
            --target x86_64-pc-windows-gnu \
            --bin kalamdb-server

      - name: Package windows artifacts
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION

          SRV_OUT="kalamdb-server-${VERSION}-windows-x86_64.exe"

          cp "target/x86_64-pc-windows-gnu/docker/kalamdb-server.exe" "dist/$VERSION/$SRV_OUT"

          (cd "dist/$VERSION" && zip -q "${SRV_OUT%.exe}.zip" "$SRV_OUT")

      - name: Upload artifacts
        if: ${{ steps.vars.outputs.build_windows == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows-x86_64
          path: dist/${{ steps.vars.outputs.version }}/*
          if-no-files-found: error

  build_macos_arm:
    name: Build macOS ARM
    runs-on: macos-14
    needs: build_ui
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}
      PLATFORMS_INPUT: ${{ github.event.inputs.platforms }}
      ALL_PLATFORMS_INPUT: ${{ github.event.inputs.all_platforms }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"

          PLATFORMS_INPUT="${PLATFORMS_INPUT:-}"
          if [[ -z "${PLATFORMS_INPUT}" ]]; then
            PLATFORMS_INPUT="${{ env.DEFAULT_PLATFORMS }}"
          fi
          if [[ "${{ github.event_name }}" == "push" ]]; then
            PLATFORMS_INPUT="${{ env.DEFAULT_PLATFORMS }}"
          fi
          if [[ "${ALL_PLATFORMS_INPUT:-}" == "true" ]]; then
            PLATFORMS_INPUT="linux-x86_64,linux-aarch64,macos-x86_64,macos-aarch64,windows-x86_64"
          fi

          BUILD_MACOS=false
          if [[ "$PLATFORMS_INPUT" == *"macos-aarch64"* ]]; then BUILD_MACOS=true; fi

          {
            echo "platforms=$PLATFORMS_INPUT"
            echo "build_macos=$BUILD_MACOS"
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Download UI dist
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

      - name: Setup Rust
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-apple-darwin

      - name: Cache Rust
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: server-macos-aarch64
          cache-on-failure: true

      - name: Install LLVM (fix libclang.dylib)
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          brew install llvm@16
          echo "LIBCLANG_PATH=$(brew --prefix llvm@16)/lib" >> "$GITHUB_ENV"
          echo "LLVM_CONFIG_PATH=$(brew --prefix llvm@16)/bin/llvm-config" >> "$GITHUB_ENV"

      - name: Build macos-aarch64 (release-dist)
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        shell: bash
        env:
          SKIP_UI_BUILD: "1"
        run: |
          set -euo pipefail
          cargo build \
            --profile release-dist \
            --target aarch64-apple-darwin \
            --bin kalamdb-server

      - name: Package macOS artifacts
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p dist/$VERSION

          SRV_OUT="kalamdb-server-${VERSION}-macos-aarch64"

          cp "target/aarch64-apple-darwin/release-dist/kalamdb-server" "dist/$VERSION/$SRV_OUT"
          chmod +x "dist/$VERSION/$SRV_OUT"

          (cd "dist/$VERSION" && tar -czf "$SRV_OUT.tar.gz" "$SRV_OUT")

      - name: Upload artifacts (macos arm)
        if: ${{ steps.vars.outputs.build_macos == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: dist-macos-arm
          path: dist/${{ steps.vars.outputs.version }}/*
          if-no-files-found: error

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - build_cli_linux_x86_64
      - build_cli_linux_aarch64
      - build_cli_windows_x86_64
      - build_cli_macos_arm
      - build_linux_x86_64
      - build_linux_aarch64
      - build_windows_x86_64
      - build_macos_arm

    if: ${{ github.event_name == 'push' || github.event.inputs.github_release == 'true' }}
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          {
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Generate SHA256SUMS
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p "dist/$VERSION"

          # Flatten artifacts into dist/<version>/
          find release-assets -type f -maxdepth 4 -print0 | while IFS= read -r -d '' f; do
            cp "$f" "dist/$VERSION/"
          done

          cd "dist/$VERSION"
          if ! ls -1 ./*.tar.gz ./*.zip >/dev/null 2>&1; then
            echo "No release artifacts found. Check workflow inputs.platforms / all_platforms." >&2
            exit 1
          fi
          sha256sum ./*.tar.gz ./*.zip > SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          generate_release_notes: true
          files: |
            dist/${{ steps.vars.outputs.version }}/*.tar.gz
            dist/${{ steps.vars.outputs.version }}/*.zip
            dist/${{ steps.vars.outputs.version }}/SHA256SUMS

  docker:
    name: Push Docker image (Docker Hub)
    runs-on: ubuntu-latest
    needs:
      - build_cli_linux_x86_64
      - build_cli_linux_aarch64
      - build_linux_x86_64
      - build_linux_aarch64

    if: ${{ github.event_name == 'push' || github.event.inputs.docker_push == 'true' }}
    env:
      VERSION_TAG_INPUT: ${{ github.event.inputs.version_tag }}
      DOCKER_REPO_INPUT: ${{ github.event.inputs.docker_repo }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag/version
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$TAG" || "$TAG" == "" ]] || [[ "$TAG" != v* ]]; then
            TAG="${VERSION_TAG_INPUT:-}"
          fi
          if [[ -z "$TAG" || "$TAG" != v* ]]; then
            echo "version_tag must start with 'v' (example: v0.1.2). Got: '$TAG'" >&2
            exit 1
          fi
          VERSION="${TAG#v}"
          {
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

          DOCKER_REPO="${DOCKER_REPO_INPUT:-}"
          if [[ -z "$DOCKER_REPO" ]]; then
            DOCKER_REPO="jamals86/kalamdb"
          fi
          echo "docker_repo=$DOCKER_REPO" >> "$GITHUB_OUTPUT"

      - name: Download pre-built artifacts (x86_64)
        uses: actions/download-artifact@v4
        with:
          name: dist-linux-x86_64
          path: artifacts/server-amd64

      - name: Download pre-built CLI artifact (x86_64)
        uses: actions/download-artifact@v4
        with:
          name: dist-cli-linux-x86_64
          path: artifacts/cli-amd64

      - name: Download pre-built artifacts (aarch64)
        uses: actions/download-artifact@v4
        with:
          name: dist-linux-aarch64
          path: artifacts/server-arm64

      - name: Download pre-built CLI artifact (aarch64)
        uses: actions/download-artifact@v4
        with:
          name: dist-cli-linux-aarch64
          path: artifacts/cli-arm64

      - name: Extract and prepare binaries (amd64)
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p binaries-amd64

          # Extract server binary
          tar -xzf "artifacts/server-amd64/kalamdb-server-${VERSION}-linux-x86_64.tar.gz" -C binaries-amd64
          mv "binaries-amd64/kalamdb-server-${VERSION}-linux-x86_64" binaries-amd64/kalamdb-server

          # Extract CLI binary
          tar -xzf "artifacts/cli-amd64/kalamcli-${VERSION}-linux-x86_64.tar.gz" -C binaries-amd64
          mv "binaries-amd64/kalamcli-${VERSION}-linux-x86_64" binaries-amd64/kalam

          chmod +x binaries-amd64/kalamdb-server binaries-amd64/kalam
          ls -la binaries-amd64/

      - name: Extract and prepare binaries (arm64)
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          mkdir -p binaries-arm64

          # Extract server binary
          tar -xzf "artifacts/server-arm64/kalamdb-server-${VERSION}-linux-aarch64.tar.gz" -C binaries-arm64
          mv "binaries-arm64/kalamdb-server-${VERSION}-linux-aarch64" binaries-arm64/kalamdb-server

          # Extract CLI binary
          tar -xzf "artifacts/cli-arm64/kalamcli-${VERSION}-linux-aarch64.tar.gz" -C binaries-arm64
          mv "binaries-arm64/kalamcli-${VERSION}-linux-aarch64" binaries-arm64/kalam

          chmod +x binaries-arm64/kalamdb-server binaries-arm64/kalam
          ls -la binaries-arm64/

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image (linux/amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/backend/Dockerfile.prebuilt
          push: true
          platforms: linux/amd64
          build-contexts: |
            binaries=binaries-amd64
          tags: |
            ${{ steps.vars.outputs.docker_repo }}:${{ steps.vars.outputs.version }}-amd64

      - name: Build and push Docker image (linux/arm64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/backend/Dockerfile.prebuilt
          push: true
          platforms: linux/arm64
          build-contexts: |
            binaries=binaries-arm64
          tags: |
            ${{ steps.vars.outputs.docker_repo }}:${{ steps.vars.outputs.version }}-arm64

      - name: Create and push multi-arch manifest
        shell: bash
        run: |
          set -euo pipefail
          REPO="${{ steps.vars.outputs.docker_repo }}"
          VERSION="${{ steps.vars.outputs.version }}"

          # Create manifest for versioned tag
          docker buildx imagetools create -t "${REPO}:${VERSION}" \
            "${REPO}:${VERSION}-amd64" \
            "${REPO}:${VERSION}-arm64"

          # Create manifest for latest tag
          docker buildx imagetools create -t "${REPO}:latest" \
            "${REPO}:${VERSION}-amd64" \
            "${REPO}:${VERSION}-arm64"

          echo "âœ… Multi-arch manifest created for ${REPO}:${VERSION} and ${REPO}:latest"
