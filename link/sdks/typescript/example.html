<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KalamDB TypeScript SDK - Browser Example</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      overflow: hidden;
    }
    .header {
      background: #2d2d30;
      padding: 15px 20px;
      border-bottom: 1px solid #3e3e42;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header h1 {
      color: #4CAF50;
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }
    .status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status.connected { background: #4CAF50; color: white; }
    .status.disconnected { background: #f44336; color: white; }
    
    .container {
      display: grid;
      grid-template-columns: 400px 1fr;
      height: calc(100vh - 60px);
    }
    
    /* Left Panel - Controls */
    .left-panel {
      background: #252526;
      border-right: 1px solid #3e3e42;
      overflow-y: auto;
      padding: 20px;
    }
    
    .section {
      background: #2d2d30;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid #3e3e42;
    }
    
    .section h2 {
      color: #4CAF50;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .section h2:hover {
      color: #66bb6a;
    }
    
    .section h2 .toggle-icon {
      font-size: 12px;
      transition: transform 0.2s;
    }
    
    .section h2 .toggle-icon.collapsed {
      transform: rotate(-90deg);
    }
    
    .section-content {
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .section-content.collapsed {
      max-height: 0;
    }
    
    .config label {
      display: block;
      color: #cccccc;
      font-size: 12px;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .config input {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 10px;
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      border-radius: 4px;
      color: #d4d4d4;
      font-size: 13px;
      font-family: 'Consolas', 'Monaco', monospace;
    }
    
    .config input:focus {
      outline: none;
      border-color: #4CAF50;
    }
    
    button {
      background: #0e639c;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      width: 100%;
      margin-bottom: 6px;
      text-align: left;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #1177bb;
    }
    
    button:disabled {
      background: #3e3e42;
      color: #808080;
      cursor: not-allowed;
    }
    
    button.danger {
      background: #f44336;
    }
    
    button.danger:hover {
      background: #d32f2f;
    }
    
    button.success {
      background: #4CAF50;
    }
    
    button.success:hover {
      background: #45a049;
    }
    
    /* Right Panel - Console */
    .right-panel {
      background: #1e1e1e;
      display: flex;
      flex-direction: column;
    }
    
    .console-header {
      background: #2d2d30;
      padding: 10px 15px;
      border-bottom: 1px solid #3e3e42;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .console-header h3 {
      color: #cccccc;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .console-actions button {
      padding: 4px 10px;
      font-size: 11px;
      width: auto;
      margin: 0 0 0 8px;
    }
    
    .sql-query-area {
      background: #2d2d30;
      padding: 15px;
      border-bottom: 1px solid #3e3e42;
    }
    
    .sql-query-area h3 {
      color: #cccccc;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }
    
    #sqlQuery {
      width: 100%;
      min-height: 80px;
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      border-radius: 4px;
      color: #d4d4d4;
      padding: 10px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
      line-height: 1.5;
    }
    
    #sqlQuery:focus {
      outline: none;
      border-color: #4CAF50;
    }
    
    .sql-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }
    
    .sql-actions button {
      width: auto;
      padding: 6px 16px;
    }
    
    #output {
      flex: 1;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      padding-bottom: 40px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      overflow-y: scroll;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.6;
      max-height: calc(100vh - 250px);
    }
    
    .json-collapsible {
      cursor: pointer;
      user-select: none;
      display: inline-block;
      margin: 4px 0;
    }
    
    .json-collapsible:hover {
      opacity: 0.8;
    }
    
    .json-content {
      max-height: 150px;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      display: inline-block;
      vertical-align: top;
    }
    
    .json-content.expanded {
      max-height: 10000px;
    }
    
    .json-toggle {
      color: #4CAF50;
      font-weight: bold;
      margin-left: 8px;
    }
    
    #subscriptionOutput {
      background: #2d2d30;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #3e3e42;
      min-height: 100px;
      max-height: 250px;
      overflow-y: auto;
      margin-top: 10px;
      font-size: 12px;
    }
    
    .log-info { color: #4FC3F7; }
    .log-error { color: #ef5350; }
    .log-success { color: #66bb6a; }
    .log-warning { color: #ffb74d; }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #3e3e42;
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #4e4e52;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üöÄ KalamDB TypeScript SDK - Browser Test</h1>
    <span id="status" class="status disconnected">Server Offline</span>
  </div>

  <div class="container">
    <!-- Left Panel - Controls -->
    <div class="left-panel">
      <div class="section">
        <h2 onclick="toggleSection('config')">
          ‚öôÔ∏è Configuration
          <span class="toggle-icon">‚ñº</span>
        </h2>
        <div class="section-content" id="config-content">
          <div class="config">
            <label>
              Server URL:
              <input type="text" id="serverUrl" value="http://localhost:8080" />
            </label>
            <label>
              Username:
              <input type="text" id="username" value="root" />
            </label>
            <label>
              Password:
              <input type="password" id="password" value="root" />
            </label>
          </div>
        </div>
      </div>

      <div class="section">
        <h2 onclick="toggleSection('basic')">
          üéÆ Basic Actions
          <span class="toggle-icon">‚ñº</span>
        </h2>
        <div class="section-content" id="basic-content">
          <button onclick="testInit()" class="success">Initialize WASM</button>
          <button onclick="testQuery()">Test Query (SELECT 1)</button>
          <button onclick="testCreateNamespace()">Create Namespace</button>
          <button onclick="testCreateTable()">Create Table</button>
          <button onclick="testInsert()">Insert Data</button>
          <button onclick="testSelect()">Query Data</button>
          <button onclick="runAll()" class="success">‚ñ∂Ô∏è Run All Tests</button>
        </div>
      </div>

      <div class="section">
        <h2 onclick="toggleSection('live')">
          üì° Live Subscriptions
          <span class="toggle-icon">‚ñº</span>
        </h2>
        <div class="section-content" id="live-content">
          <button onclick="testSubscribe()" id="subscribeBtn">üîî Subscribe to Todos</button>
          <button onclick="testUnsubscribe()" id="unsubscribeBtn" disabled>üîï Unsubscribe</button>
          <button onclick="testInsertLive()" id="insertLiveBtn" disabled>‚ûï Insert New Todo (Live)</button>
          <div id="subscriptionOutput">
            <div style="color: #808080; font-style: italic; font-size: 11px;">No active subscription</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2 onclick="toggleSection('stream')">
          üåä Stream Subscriptions
          <span class="toggle-icon">‚ñº</span>
        </h2>
        <div class="section-content" id="stream-content">
          <button onclick="testCreateAndSubscribeTodos()" id="createSubTodosBtn">üìã Create & Subscribe Todos</button>
          <button onclick="testCreateAndSubscribeEvents()" id="createSubEventsBtn">‚ö° Create & Subscribe Events (Stream)</button>
          <button onclick="testInsertEvent()" id="insertEventBtn" disabled>‚ûï Insert Event</button>
          <button onclick="testUnsubscribeAll()" id="unsubscribeAllBtn" disabled class="danger">üîï Unsubscribe All</button>
        </div>
      </div>
    </div>

    <!-- Right Panel - Console -->
    <div class="right-panel">
      <!-- SQL Query Area -->
      <div class="sql-query-area">
        <h3>üí¨ SQL Query</h3>
        <textarea id="sqlQuery" placeholder="Enter SQL query here... (e.g., SELECT * FROM my_namespace.todos)"></textarea>
        <div class="sql-actions">
          <button onclick="executeSqlQuery()" class="success">‚ñ∂Ô∏è Execute</button>
          <button onclick="clearSqlQuery()">Clear</button>
        </div>
      </div>
      
      <div class="console-header">
        <h3>üìã Console Output</h3>
        <div class="console-actions">
          <button onclick="clearOutput()" class="danger">Clear</button>
        </div>
      </div>
      <div id="output">Waiting for actions...</div>
    </div>
  </div>

  <script type="module">
    import { KalamDBClient } from './dist/index.js';

    /** @type {KalamDBClient | null} */
    let client = null;
    
    /** @type {string | null} */
    let subscriptionId = null;
    
    /** @type {string | null} */
    let eventsSubscriptionId = null;
    
    /** @type {number | null} */
    let healthCheckInterval = null;

    // Start health check monitoring
    async function startHealthCheck() {
      const config = getConfig();
      const checkHealth = async () => {
        try {
          const response = await fetch(`${config.url}/v1/api/healthcheck`, {
            method: 'GET',
            headers: {
              'Accept': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            updateStatus(true, data.status || 'healthy');
          } else {
            updateStatus(false, 'unhealthy');
          }
        } catch (error) {
          updateStatus(false, 'offline');
        }
      };

      // Initial check
      await checkHealth();
      
      // Check every 5 seconds
      if (healthCheckInterval) {
        clearInterval(healthCheckInterval);
      }
      healthCheckInterval = setInterval(checkHealth, 3000);
    }

    // Start health check and auto-initialize on page load
    window.addEventListener('load', async () => {
      await startHealthCheck();
      await testInit();
    });

    function log(message, type = 'info', collapsible = false) {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const className = `log-${type}`;
      
      if (collapsible) {
        const id = `json-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        const preview = message.split('\n').slice(0, 3).join('\n');
        const lines = message.split('\n').length;
        
        output.innerHTML += `<span class="${className}">[${timestamp}] <span class="json-collapsible" onclick="toggleJson('${id}')">
<span class="json-content" id="${id}" data-full="${encodeURIComponent(message)}">${preview}${lines > 3 ? '\n...' : ''}</span><span class="json-toggle">[${lines > 3 ? 'expand' : 'collapse'}]</span></span></span>\n`;
      } else {
        output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      }
      
      output.scrollTop = output.scrollHeight;
    }

    function updateStatus(online, statusText = null) {
      const status = document.getElementById('status');
      if (online) {
        status.textContent = statusText ? `Server Online (${statusText})` : 'Server Online';
        status.className = 'status connected';
      } else {
        status.textContent = statusText ? `Server Offline (${statusText})` : 'Server Offline';
        status.className = 'status disconnected';
      }
    }

    function getConfig() {
      return {
        url: document.getElementById('serverUrl').value,
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
      };
    }

    window.testInit = async function() {
      try {
        log('üîß Initializing WASM and creating client...', 'info');
        const config = getConfig();
        
        client = new KalamDBClient(config.url, config.username, config.password);
        await client.initialize();
        
        log('‚úÖ WASM initialized successfully!', 'success');
        log(`   Server: ${config.url}`, 'info');
        log(`   User: ${config.username}`, 'info');
      } catch (error) {
        log(`‚ùå Initialization failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.testQuery = async function() {
      if (!client) {
        log('‚ö†Ô∏è  Please initialize first!', 'warning');
        return;
      }

      try {
        log('üìä Executing query: SELECT 1 as number, \'hello\' as text', 'info');
        const result = await client.query("SELECT 1 as number, 'hello' as text");
        
        log('‚úÖ Query executed successfully!', 'success');
        log(`   Status: ${result.status}`, 'info');
        log(`   Rows: ${JSON.stringify(result.results[0].rows)}`, 'info');
        log(`   Took: ${result.took}ms`, 'info');
      } catch (error) {
        log(`‚ùå Query failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.testCreateNamespace = async function() {
      if (!client) {
        log('‚ö†Ô∏è  Please initialize first!', 'warning');
        return;
      }

      try {
        log('üì¶ Creating namespace: test_browser', 'info');
        const result = await client.query('CREATE NAMESPACE IF NOT EXISTS test_browser');
        
        log('‚úÖ Namespace created!', 'success');
        log(`   Status: ${result.status}`, 'info');
      } catch (error) {
        log(`‚ùå Failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.testCreateTable = async function() {
      if (!client) {
        log('‚ö†Ô∏è  Please initialize first!', 'warning');
        return;
      }

      try {
        log('üìã Creating table: test_browser.todos', 'info');
        const result = await client.query(`
          CREATE TABLE IF NOT EXISTS test_browser.todos (
            id BIGINT PRIMARY KEY DEFAULT SNOWFLAKE_ID(),
            title TEXT NOT NULL,
            completed BOOLEAN DEFAULT false,
            priority TEXT DEFAULT 'medium',
            created_at TIMESTAMP DEFAULT NOW()
          ) WITH (TYPE='SHARED', FLUSH_POLICY='rows:100')
        `);
        
        log('‚úÖ Table created!', 'success');
        log(`   Status: ${result.status}`, 'info');
      } catch (error) {
        log(`‚ùå Failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.testInsert = async function() {
      if (!client) {
        log('‚ö†Ô∏è  Please initialize first!', 'warning');
        return;
      }

      try {
        log('‚ûï Inserting 3 todos...', 'info');
        
        await client.insert('test_browser.todos', {
          title: 'Test from browser',
          priority: 'high',
          completed: false
        });
        
        await client.insert('test_browser.todos', {
          title: 'TypeScript SDK works!',
          priority: 'medium',
          completed: true
        });
        
        await client.insert('test_browser.todos', {
          title: 'WASM is awesome',
          priority: 'high',
          completed: false
        });
        
        log('‚úÖ 3 todos inserted!', 'success');
      } catch (error) {
        log(`‚ùå Failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.testSelect = async function() {
      if (!client) {
        log('‚ö†Ô∏è  Please initialize first!', 'warning');
        return;
      }

      try {
        log('üîç Querying todos...', 'info');
        const result = await client.query(`
          SELECT * FROM test_browser.todos 
          ORDER BY priority DESC, created_at ASC
        `);
        
        log('‚úÖ Query successful!', 'success');
        log(`   Found ${result.results[0].row_count} todos:`, 'info');
        
        if (result.results[0].rows) {
          result.results[0].rows.forEach((todo, index) => {
            const status = todo.completed ? '‚úì' : '‚óã';
            const priority = todo.priority.toUpperCase();
            log(`   ${index + 1}. [${status}] ${priority.padEnd(6)} ${todo.title}`, 'info');
          });
        }
      } catch (error) {
        log(`‚ùå Failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.runAll = async function() {
      clearOutput();
      log('üöÄ Running all tests...', 'info');
      log('‚ïê'.repeat(60), 'info');
      
      await testInit();
      await new Promise(r => setTimeout(r, 500));
      
      await testQuery();
      await new Promise(r => setTimeout(r, 500));
      
      await testCreateNamespace();
      await new Promise(r => setTimeout(r, 500));
      
      await testCreateTable();
      await new Promise(r => setTimeout(r, 500));
      
      await testInsert();
      await new Promise(r => setTimeout(r, 500));
      
      await testSelect();
      
      log('‚ïê'.repeat(60), 'info');
      log('üéâ All tests completed!', 'success');
    };

    window.testSubscribe = async function() {
      if (!client) {
        log('‚ö†Ô∏è  Please initialize first!', 'warning');
        return;
      }

      try {
        // Connect to WebSocket if not already connected
        log('üîå Connecting to server for subscriptions...', 'info');
        await client.connect();
        log('‚úÖ Connected to server!', 'success');
        
        log('üì° Subscribing to test_browser.todos...', 'info');
        
        // Make sure table exists first
        await client.query('CREATE TABLE IF NOT EXISTS test_browser.todos (id BIGINT PRIMARY KEY DEFAULT SNOWFLAKE_ID(), title TEXT NOT NULL, completed BOOLEAN DEFAULT false, priority TEXT DEFAULT \'medium\', created_at TIMESTAMP DEFAULT NOW()) WITH (TYPE=\'SHARED\', FLUSH_POLICY=\'rows:100\')');
        
        subscriptionId = await client.subscribe(
          'test_browser.todos',
          (data) => {
            const subOutput = document.getElementById('subscriptionOutput');
            const timestamp = new Date().toLocaleTimeString();
            
            log(`üì® [TODOS] Received subscription data: ${data.rows?.length || 0} rows`, 'success');
            
            if (data.rows && data.rows.length > 0) {
              // Log to console
              data.rows.forEach(row => {
                const status = row.completed ? '‚úì' : '‚óã';
                log(`   ${status} [${row.priority?.toUpperCase()}] ${row.title}`, 'info');
              });
              
              // Update subscription output div
              let html = `<div style="color: #4CAF50; font-weight: bold; margin-bottom: 10px;">üì° Live Updates (Last: ${timestamp})</div>`;
              data.rows.forEach(row => {
                const status = row.completed ? '‚úì' : '‚óã';
                const priorityColor = row.priority === 'high' ? '#ef5350' : row.priority === 'medium' ? '#ffb74d' : '#66bb6a';
                html += `<div style="padding: 8px; margin: 5px 0; background: #2d2d30; border-left: 3px solid ${priorityColor}; border-radius: 3px;">`;
                html += `<span style="font-size: 16px; margin-right: 8px;">${status}</span>`;
                html += `<strong style="color: #d4d4d4;">${row.title}</strong> `;
                html += `<span style="color: ${priorityColor}; font-size: 10px; text-transform: uppercase;">[${row.priority}]</span>`;
                html += `<div style="font-size: 10px; color: #808080; margin-top: 4px;">ID: ${row.id}</div>`;
                html += `</div>`;
              });
              subOutput.innerHTML = html;
            } else {
              subOutput.innerHTML = `<div style="color: #808080; font-style: italic; font-size: 11px;">Subscribed. Waiting for data... (${timestamp})</div>`;
            }
          },
          { /* filters can go here */ }
        );
        
        log(`‚úÖ Subscribed! Subscription ID: ${subscriptionId}`, 'success');
        log('   Waiting for live updates...', 'info');
        
        // Update button states
        document.getElementById('subscribeBtn').disabled = true;
        document.getElementById('unsubscribeBtn').disabled = false;
        document.getElementById('insertLiveBtn').disabled = false;
        updateUnsubscribeAllButton();
        
      } catch (error) {
        log(`‚ùå Subscription failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.testUnsubscribe = async function() {
      if (!client || !subscriptionId) {
        log('‚ö†Ô∏è  No active subscription!', 'warning');
        return;
      }

      try {
        log(`üì° Unsubscribing from subscription ${subscriptionId}...`, 'info');
        await client.unsubscribe(subscriptionId);
        
        log('‚úÖ Unsubscribed successfully!', 'success');
        subscriptionId = null;
        
        // Update button states
        document.getElementById('subscribeBtn').disabled = false;
        document.getElementById('unsubscribeBtn').disabled = true;
        document.getElementById('insertLiveBtn').disabled = true;
        updateUnsubscribeAllButton();
        
        // Clear subscription output
        document.getElementById('subscriptionOutput').innerHTML = '<div style="color: #808080; font-style: italic; font-size: 11px;">Unsubscribed. Click "Subscribe to Todos" to start again.</div>';
        
      } catch (error) {
        log(`‚ùå Unsubscribe failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.testInsertLive = async function() {
      if (!client) {
        log('‚ö†Ô∏è  Please initialize first!', 'warning');
        return;
      }

      if (!subscriptionId) {
        log('‚ö†Ô∏è  Please subscribe first!', 'warning');
        return;
      }

      try {
        const priorities = ['low', 'medium', 'high'];
        const tasks = [
          'Review pull request',
          'Update documentation',
          'Fix critical bug',
          'Deploy to production',
          'Write unit tests',
          'Refactor authentication',
          'Optimize database queries',
          'Design new API endpoint'
        ];
        
        const randomTask = tasks[Math.floor(Math.random() * tasks.length)];
        const randomPriority = priorities[Math.floor(Math.random() * priorities.length)];
        const randomCompleted = Math.random() > 0.7;
        
        log(`‚ûï Inserting live todo: "${randomTask}" [${randomPriority}]...`, 'info');
        
        await client.insert('test_browser.todos', {
          title: randomTask,
          priority: randomPriority,
          completed: randomCompleted
        });
        
        log('‚úÖ Todo inserted! Watch the subscription output update...', 'success');
        
      } catch (error) {
        log(`‚ùå Insert failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.testCreateAndSubscribeTodos = async function() {
      if (!client) {
        log('‚ö†Ô∏è  Please initialize first!', 'warning');
        return;
      }

      try {
        // Connect to WebSocket if not already connected
        log('üîå Connecting to server for subscriptions...', 'info');
        await client.connect();
        log('‚úÖ Connected to server!', 'success');
        
        log('üìã Creating and subscribing to test_browser.todos (SHARED table)...', 'info');
        
        // Create table
        await client.query(`
          CREATE TABLE IF NOT EXISTS test_browser.todos (
            id BIGINT PRIMARY KEY DEFAULT SNOWFLAKE_ID(), 
            title TEXT NOT NULL, 
            completed BOOLEAN DEFAULT false, 
            priority TEXT DEFAULT 'medium', 
            created_at TIMESTAMP DEFAULT NOW()
          ) WITH (TYPE='SHARED', FLUSH_POLICY='rows:100')
        `);
        
        log('‚úÖ Table created!', 'success');
        
        // Subscribe
        subscriptionId = await client.subscribe(
          'test_browser.todos',
          (data) => {
            log(`üì® [TODOS] Received subscription data: ${data.rows?.length || 0} rows`, 'success');
            
            if (data.rows && data.rows.length > 0) {
              data.rows.forEach(row => {
                const status = row.completed ? '‚úì' : '‚óã';
                log(`   ${status} [${row.priority?.toUpperCase()}] ${row.title}`, 'info');
              });
            }
          },
          { /* filters can go here */ }
        );
        
        log(`‚úÖ Subscribed to todos! ID: ${subscriptionId}`, 'success');
        
        // Update button states
        document.getElementById('subscribeBtn').disabled = true;
        document.getElementById('unsubscribeBtn').disabled = false;
        document.getElementById('insertLiveBtn').disabled = false;
        updateUnsubscribeAllButton();
        
      } catch (error) {
        log(`‚ùå Failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.testCreateAndSubscribeEvents = async function() {
      if (!client) {
        log('‚ö†Ô∏è  Please initialize first!', 'warning');
        return;
      }

      try {
        // Connect to WebSocket if not already connected
        if (!client.isConnected()) {
          log('üîå Connecting to server for subscriptions...', 'info');
          await client.connect();
          log('‚úÖ Connected to server!', 'success');
        }
        
        log('‚ö° Creating and subscribing to test_browser.events (STREAM table)...', 'info');
        
        // Create STREAM table
        await client.query(`
          CREATE TABLE IF NOT EXISTS test_browser.events (
            id BIGINT PRIMARY KEY DEFAULT SNOWFLAKE_ID(), 
            event_type TEXT NOT NULL, 
            user_id TEXT, 
            payload TEXT, 
            timestamp TIMESTAMP DEFAULT NOW()
          ) WITH (TYPE='STREAM')
        `);
        
        log('‚úÖ Stream table created!', 'success');
        
        // Subscribe to stream
        eventsSubscriptionId = await client.subscribe(
          'test_browser.events',
          (data) => {
            log(`üì® [EVENTS] Received event: ${data.rows?.length || 0} rows`, 'success');
            
            if (data.rows && data.rows.length > 0) {
              data.rows.forEach(row => {
                log(`   üîî ${row.event_type}: ${row.payload || 'no payload'} (user: ${row.user_id || 'N/A'})`, 'info');
              });
            }
          },
          { /* filters can go here */ }
        );
        
        log(`‚úÖ Subscribed to events stream! ID: ${eventsSubscriptionId}`, 'success');
        
        // Update button states
        document.getElementById('createSubEventsBtn').disabled = true;
        document.getElementById('insertEventBtn').disabled = false;
        updateUnsubscribeAllButton();
        
      } catch (error) {
        log(`‚ùå Failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.testInsertEvent = async function() {
      if (!client) {
        log('‚ö†Ô∏è  Please initialize first!', 'warning');
        return;
      }

      if (!eventsSubscriptionId) {
        log('‚ö†Ô∏è  Please subscribe to events first!', 'warning');
        return;
      }

      try {
        const eventTypes = ['user_login', 'user_logout', 'page_view', 'button_click', 'api_call', 'error_occurred', 'data_saved'];
        const userIds = ['user_001', 'user_002', 'user_003', 'alice', 'bob', 'charlie'];
        const payloads = [
          '{"page": "/dashboard"}',
          '{"button": "submit"}',
          '{"endpoint": "/api/users"}',
          '{"error": "timeout"}',
          '{"table": "todos"}',
          '{"session": "abc123"}',
          '{"duration": 1234}'
        ];
        
        const randomEventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];
        const randomUserId = userIds[Math.floor(Math.random() * userIds.length)];
        const randomPayload = payloads[Math.floor(Math.random() * payloads.length)];
        
        log(`‚ûï Inserting event: ${randomEventType} (${randomUserId})...`, 'info');
        
        await client.insert('test_browser.events', {
          event_type: randomEventType,
          user_id: randomUserId,
          payload: randomPayload
        });
        
        log('‚úÖ Event inserted! Watch the subscription output...', 'success');
        
      } catch (error) {
        log(`‚ùå Insert failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.testUnsubscribeAll = async function() {
      if (!client) {
        log('‚ö†Ô∏è  No client initialized!', 'warning');
        return;
      }

      try {
        let unsubscribed = false;
        
        if (subscriptionId) {
          log(`üì° Unsubscribing from todos (${subscriptionId})...`, 'info');
          await client.unsubscribe(subscriptionId);
          log('‚úÖ Unsubscribed from todos!', 'success');
          subscriptionId = null;
          unsubscribed = true;
          
          // Update button states
          document.getElementById('subscribeBtn').disabled = false;
          document.getElementById('unsubscribeBtn').disabled = true;
          document.getElementById('insertLiveBtn').disabled = true;
        }
        
        if (eventsSubscriptionId) {
          log(`üì° Unsubscribing from events (${eventsSubscriptionId})...`, 'info');
          await client.unsubscribe(eventsSubscriptionId);
          log('‚úÖ Unsubscribed from events!', 'success');
          eventsSubscriptionId = null;
          unsubscribed = true;
          
          // Update button states
          document.getElementById('createSubEventsBtn').disabled = false;
          document.getElementById('insertEventBtn').disabled = true;
        }
        
        if (!unsubscribed) {
          log('‚ö†Ô∏è  No active subscriptions!', 'warning');
        }
        
        updateUnsubscribeAllButton();
        
      } catch (error) {
        log(`‚ùå Unsubscribe failed: ${error.message}`, 'error');
        console.error(error);
      }
    };

    function updateUnsubscribeAllButton() {
      const hasSubscriptions = subscriptionId !== null || eventsSubscriptionId !== null;
      document.getElementById('unsubscribeAllBtn').disabled = !hasSubscriptions;
    }

    window.toggleSection = function(sectionId) {
      const content = document.getElementById(`${sectionId}-content`);
      const icon = content.previousElementSibling.querySelector('.toggle-icon');
      
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        icon.classList.remove('collapsed');
        icon.textContent = '‚ñº';
      } else {
        content.classList.add('collapsed');
        icon.classList.add('collapsed');
        icon.textContent = '‚ñ∂';
      }
    };

    window.executeSqlQuery = async function() {
      const sqlQuery = document.getElementById('sqlQuery').value.trim();
      
      if (!sqlQuery) {
        log('‚ö†Ô∏è  Please enter a SQL query!', 'warning');
        return;
      }

      if (!client) {
        log('‚ö†Ô∏è  Please initialize the client first!', 'warning');
        return;
      }

      try {
        log(`üîç Executing SQL: ${sqlQuery}`, 'info');
        const result = await client.query(sqlQuery);
        
        if (result && result.length > 0) {
          log(`‚úÖ Query returned ${result.length} row(s):`, 'success');
          log(JSON.stringify(result, null, 2), 'info', true);
        } else if (result && typeof result === 'object') {
          log('‚úÖ Query executed successfully:', 'success');
          log(JSON.stringify(result, null, 2), 'info', true);
        } else {
          log('‚úÖ Query executed successfully (no data returned)', 'success');
        }
      } catch (error) {
        log(`‚ùå SQL execution failed: ${error.message}`, 'error');
        console.error(error);
      }
    };
    
    // Add Ctrl+Enter handler for SQL textarea
    document.addEventListener('DOMContentLoaded', function() {
      const sqlQuery = document.getElementById('sqlQuery');
      if (sqlQuery) {
        sqlQuery.addEventListener('keydown', function(e) {
          if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            executeSqlQuery();
          }
        });
      }
    });
    
    window.toggleJson = function(id) {
      const element = document.getElementById(id);
      const toggle = element.nextElementSibling;
      const fullContent = decodeURIComponent(element.getAttribute('data-full'));
      
      if (element.classList.contains('expanded')) {
        element.classList.remove('expanded');
        const preview = fullContent.split('\n').slice(0, 3).join('\n');
        const lines = fullContent.split('\n').length;
        element.textContent = preview + (lines > 3 ? '\n...' : '');
        toggle.textContent = '[expand]';
      } else {
        element.classList.add('expanded');
        element.textContent = fullContent;
        toggle.textContent = '[collapse]';
      }
    };

    window.clearSqlQuery = function() {
      document.getElementById('sqlQuery').value = '';
    };

    window.clearOutput = function() {
      document.getElementById('output').innerHTML = '';
    };
  </script>
</body>
</html>
